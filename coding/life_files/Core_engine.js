var show_logs=false;
var mc_key_l;
var mc_key_n;
var locationtxt="my location";
var locationvect=[];
var locationvect_index=[];
var uplocation=null;
var lastuplocation=null;
var uplocvect=[];
var doingupzoom=false;
var popuptext=null;
var popuptext2=null;
var justopened=true;
var zoominnum;
var zoomoutnum;
var timer4fps;
var counter4pfs;
var pics_unloaded=false;
var popupin;
var last_searched=null;
var postaction_since_reset=0;
var signthresh=thresholdnode;
var maxradius=Math.max(heightres*0.65,widthres*0.65,1000);
var maxfromedgexl=(widthres/10);
var maxfromedgeyl=(heightres/10);
var maxfromedgex=(widthres/12);
var maxfromedgey=(heightres/12);
var maxfromedgexs=(widthres/11);
var maxfromedgeys=(heightres/11);
var OKup=1;
var OKdown=1;
var OKleft=1;
var OKright=1;
var OKzoom=1;
var OKrlim=1;

function reset_MR(){OKup=0;OKdown=0;OKleft=0;OKright=0;OKzoom=0;OKrlim=0}
function add_MR(h,g,a){if((((h+a)>0)&&((h-a)<(widthres)))&&(((g+a)>0)&&((g-a)<(heightres)))){if(OKup==0){if(((h+a)>maxfromedgex)&&((h-a)<(widthres-maxfromedgex))){var e;if(h<maxfromedgex){e=Math.pow(a*a-(h-maxfromedgex)*(h-maxfromedgex),0.5)+g}else{if(h>(widthres-maxfromedgex)){e=Math.pow(a*a-(h-widthres+maxfromedgex)*(h-widthres+maxfromedgex),0.5)+g}else{e=a+g}}if(e>maxfromedgeyl){OKup=1}}}if(OKdown==0){if(((h+a)>maxfromedgex)&&((h-a)<(widthres-maxfromedgex))){var e;if(h<maxfromedgex){e=Math.pow(a*a-(h-maxfromedgex)*(h-maxfromedgex),0.5)+heightres-g}else{if(h>(widthres-maxfromedgex)){e=Math.pow(a*a-(h-widthres+maxfromedgex)*(h-widthres+maxfromedgex),0.5)+heightres-g}else{e=heightres-g+a}}if(e>maxfromedgeyl){OKdown=1}}}if(OKleft==0){if(((g+a)>maxfromedgey)&&((g-a)<(heightres-maxfromedgey))){var e;if(g<maxfromedgey){e=Math.pow(a*a-(g-maxfromedgey)*(g-maxfromedgey),0.5)+h}else{if(g>(heightres-maxfromedgey)){e=Math.pow(a*a-(g-heightres+maxfromedgey)*(g-heightres+maxfromedgey),0.5)+h}else{e=h+a}}if(e>maxfromedgexl){OKleft=1}}}if(OKright==0){if(((g+a)>maxfromedgey)&&((g-a)<(heightres-maxfromedgey))){var e;if(g<maxfromedgey){e=Math.pow(a*a-(g-maxfromedgey)*(g-maxfromedgey),0.5)+widthres-h}else{if(g>(heightres-maxfromedgey)){e=Math.pow(a*a-(g-heightres+maxfromedgey)*(g-heightres+maxfromedgey),0.5)+widthres-h}else{e=widthres-h+a}}if(e>maxfromedgexl){OKright=1}}}if(a<maxradius){OKrlim=1}if(OKzoom==0){var b=maxfromedgexs+((1-sensitivity)*mouseX);var k=maxfromedgexs+((1-sensitivity)*(widthres-mouseX));var f=maxfromedgeys+((1-sensitivity)*mouseY);var d=maxfromedgeys+((1-sensitivity)*(heightres-mouseY));if(((((h+a)>b)&&((h-a)<(widthres-k)))&&(((g+a)>f)&&((g-a)<(heightres-d))))){var c=1;var e=0;if(h<b){e=Math.pow(a*a-(h-b)*(h-b),0.5)+g}else{if(h>(widthres-k)){e=Math.pow(a*a-(h-(widthres-k))*(h-(widthres-k)),0.5)+g}else{e=a+g}}if((e<f)){c=0}if(h<b){e=Math.pow(a*a-(h-b)*(h-b),0.5)+(heightres-b)-g}else{if(h>(widthres-k)){e=Math.pow(a*a-(h-(widthres-k))*(h-(widthres-k)),0.5)+(heightres)-g}else{e=heightres-g+a}}if((e<d)){c=0}if(g<f){e=Math.pow(a*a-(g-f)*(g-f),0.5)+h}else{if(g>(heightres-d)){e=Math.pow(a*a-(g-(heightres-d))*(g-(heightres-d)),0.5)+h}else{e=h+a}}if((e<b)){c=0}if(g<f){e=Math.pow(a*a-(g-f)*(g-f),0.5)+(widthres)-h}else{if(g>(heightres-d)){e=Math.pow(a*a-(g-(heightres-d))*(g-(heightres-d)),0.5)+(widthres)-h}else{e=(widthres)-h+a}}if((e<k)){c=0}if(c==1){OKzoom=1}}}}}
function report_MR(){if(OKup==0){console.log("failed up")}if(OKdown==0){console.log("failed down")}if(OKleft==0){console.log("failed left")}if(OKright==0){console.log("failed right")}if(OKzoom==0){console.log("failed zoom")}}

var init;
var zfact;
var zspeed;
var newURL;
var searchvect;

function URL_parse(){init="jump";zfact=2;zspeed=7;newURL="";searchvect=new Array();var a=window.location.search;var b=window.location.hash;if(a.length>1){a=a.split("%20").join(" ");a=a.substring(1);a=a.toString();var d=a.split("&");for(ii=0;ii<d.length;ii++){var c=d[ii];tempURLparts=c.split("=");if(tempURLparts[0]=="init"){init=tempURLparts[1]}else{if(tempURLparts[0]=="zfact"){zfact=tempURLparts[1]}else{if(tempURLparts[0]=="zspeed"){zspeed=tempURLparts[1]}else{if(tempURLparts[0]=="newURL"){newURL=tempURLparts[1]}}}}}}if(b.length>1){b=b.split("%20").join(" ");b=b.substring(1);b=b.toString();var e=b.split(",");for(ii=0;ii<e.length;ii++){searchvect.push(e[ii])}}}
midnode.prototype.match_URL=function(a){if(a){a=a.toString();if(this.child1){if(a&&(((this.name1)&&(this.name1.toLowerCase()==a.toLowerCase()))||((metadata.node_meta[this.metacode])&&((metadata.node_meta[this.metacode][mc_key_n.OTTid])&&((("ott"+(metadata.node_meta[this.metacode][mc_key_n.OTTid]))==(a))))))){return(this.metacode)}else{return(null)}}else{if(a&&(("ott"+(metadata.leaf_meta[this.metacode][mc_key_l.OTTid]))==(a))||((((this.name1)&&(this.name1.toLowerCase()==a.toLowerCase()))||((this.name2)&&(this.name2.toLowerCase()==a.toLowerCase())))||(((this.name1)&&(this.name2))&&((this.name2+"_"+this.name1).toLowerCase()==a.toLowerCase())))){return(-1*(this.metacode))}else{return(null)}}}};

midnode.prototype.OZID_from_URL=function(c){if(c&&(c.length>0)){if(this.child1){var b=c;if(this.match_URL(b[0])){b=b.slice(1,b.length);if(this.match_URL(b[0])){b=b.slice(1,b.length)}}if(b.length==0){return([this.metacode,1])}else{var a=this.child1.OZID_from_URL(b);var d=this.child2.OZID_from_URL(b);if(a&&a[0]){if(d&&d[0]){if(a[1]<d[1]){return([a[0],(a[1]+1)])}else{if(d[1]<a[1]){return([d[0],(d[1]+1)])}else{return([this.metacode,1])}}}else{return([a[0],(a[1]+1)])}}else{if(d&&d[0]){return([d[0],(d[1]+1)])}else{return(null)}}}}else{for(ii=0;ii<c.length;ii++){if(!(this.match_URL(c[ii]))){return(null)}}return([-1*(this.metacode),1])}}else{return(null)}};

function getBaseLog(a,b){return Math.log(b)/Math.log(a)}midnode.prototype.measure_size=function(){var d=1/1.3;var c=1/2.25;if(this.child1){if((this.child1.richness_val)>=(this.child2.richness_val)){var b=(this.child1).measure_size()/d;var a=(this.child2).measure_size()/c;return(Math.max(b,a))}else{var b=(this.child1).measure_size()/c;var a=(this.child2).measure_size()/d;return(Math.max(b,a))}}else{return(1)}};

midnode.prototype.OZID_from_OTTID2=function(c,c){if(this.child1){if((metadata.node_meta[this.metacode][mc_key_n.OTTid]==c)||(metadata.node_meta[this.metacode][mc_key_n.OTTid]==OTTID_in2)){return(this.metacode)}else{var b=(this.child1).OZID_from_OTTID(c);var a=(this.child1).OZID_from_OTTID(OTTID_in2);if(b!=null){if(b!=null){return(temp_OZID)}else{return((this.child2).OZID_from_OTTID(OTTID_in))}}else{if(b!=null){return(temp_OZID)}else{return((this.child2).OZID_from_OTTID(OTTID_in))}}if(b!=null){return(temp_OZID)}else{return((this.child2).OZID_from_OTTID(OTTID_in))}}}else{if(metadata.leaf_meta[this.metacode][mc_key_l.OTTid]==OTTID_in){return(-1*(this.metacode))}else{return(null)}}};

midnode.prototype.OZID_from_OTTID=function(a){if(this.child1){if(metadata.node_meta[this.metacode][mc_key_n.OTTid]==a){return(this.metacode)}else{var b=(this.child1).OZID_from_OTTID(a);if(b!=null){return(b)}else{return((this.child2).OZID_from_OTTID(a))}}}else{if(metadata.leaf_meta[this.metacode][mc_key_l.OTTid]==a){return(-1*(this.metacode))}else{return(null)}}};

function screen_saver_start(){searchstring="";manusersearchclear();screensaver_on=true;if(((!flying)&&(!growing))&&(!mousehold)){clearTimeout(tout_ss);viewchange_due=false;if(screen_saver.switch_wait>=0){tout_sw=setTimeout("viewchange_due_on()",screen_saver.switch_wait*100)}screen_saver_preaction()}else{clear_screensaver()}}
function clear_screensaver(){if(!flying_2){flying=false;clearTimeout(t)}clearTimeout(tout_ss);clearTimeout(tout_sw);clearTimeout(tout_aw);if(screensaver_on){growend();screensaver_on=false;viewchange_due=false;if(thisSound.duration){thisSound.currentTime=thisSound.duration;nowplaying=null}}}
function screen_saver_restart(){if(newURL&&(newURL!="")){window.location.href=("./"+newURL)}else{location.reload()}}
function screen_saver_preaction(){if(viewchange_due){random_switch();viewchange_due=false;if(screen_saver.switch_wait>=0){tout_sw=setTimeout("viewchange_due_on()",screen_saver.switch_wait*100)}}else{var a=Math.random();if(a<(screen_saver.zoomin__+screen_saver.zoomin_random+screen_saver.slideshow)){if(a<(screen_saver.zoomin__+screen_saver.zoomin_random)){slideshow_progress=-1;highlight_search=true;performfly();draw2()}else{slideshow_progress=screen_saver.sslength;highlight_search=false;performleap();draw2()}}else{ResetSS();draw2();growplay()}}}
var slideshow_progress=0;
function viewchange_due_on(){viewchange_due=true}
function random_switch(){var a=Math.random();if(a<(screen_saver.natural_prop)){viewtype=2}else{if(a<((screen_saver.natural_prop)+(screen_saver.spiral_prop))){viewtype=1}else{if(a<((screen_saver.natural_prop)+(screen_saver.spiral_prop)+(screen_saver.feather_prop))){viewtype=3}else{viewtype=4}}}draw_loading();setTimeout("form_change2()",1)}
function screen_saver_postaction(){draw2();postaction_since_reset++;if(postaction_since_reset<10){if(screen_saver.animation_wait>=0){tout_aw=setTimeout("screen_saver_preaction()",screen_saver.animation_wait*100)}}else{location.reload()}}
function screen_saver_postaction2(){fulltree.deanchor();fulltree.graphref=true;fulltree.clearsearch();fulltree.clearonroute();fulltree.setxyr3r(40,widthres-40,40,heightres-40);wsinit=ws;draw2();postaction_since_reset++;if(postaction_since_reset<10){if(screen_saver.animation_wait>=0){tout_aw=setTimeout("screen_saver_preaction()",screen_saver.animation_wait*100)}}else{location.reload()}}
function add_listeners(){myCanvas.onmousedown=holdon;myCanvas.onmouseup=holdoff;myCanvas.onmouseout=holdoff2;myCanvas.onmousemove=movemouse;myCanvas.onmousein=domousein;if(myCanvas.addEventListener){myCanvas.addEventListener("mousewheel",mousewheel,false);myCanvas.addEventListener("DOMMouseScroll",mousewheel,false)}else{if(myCanvas.attachEvent){myCanvas.attachEvent("onmousewheel",mousewheel)}}myCanvas.addEventListener("touchstart",touch_start,false);myCanvas.addEventListener("touchmove",touch_move,false);myCanvas.addEventListener("touchend",touch_end,false)}
function init_after_load(){mc_key_l={};for(jj=0;jj<(metadata.leaf_meta[0].length);jj++){mc_key_l[metadata.leaf_meta[0][jj]]=jj}mc_key_n={};for(jj=0;jj<(metadata.node_meta[0].length);jj++){mc_key_n[metadata.node_meta[0][jj]]=jj}URL_parse();nowloading=true;touchX.length=2;touchY.length=2;popupin=true;shapechanged=false;zoominnum=7;zoomoutnum=7;buttonoptions=0;postaction_since_reset=0;if(typeof(init_UI)==="function"){init_UI()}if(typeof(init_Logo)==="function"){init_Logo()}makepic_vect2();datahastraits=true;fulltree=null;fulltree=new midnode(rawData);fulltree.richness_calc();fulltree.leaf_richness_calc();fulltree.metacalc();fulltree.concalc();if(auto_interior_node_labels){fulltree.name_calc()}fulltree.age_calc();if(auto_interior_node_labels){fulltree.inlabel_calc(null)}fulltree.pic_calc();fulltree.picsort();fulltree.numgp_counter();fulltree.spsort(2,2);update_form();setTimeout("init3();",1)}
function init3(){setupPopular();temp_OZID=(fulltree.OZID_from_URL(searchvect));if(temp_OZID&&temp_OZID[0]){search_init(temp_OZID[0])}else{if(screen_saver.start_on_ss){fulltree.setxyr3r(40,widthres-40,40,heightres-40);wsinit=ws;Reset();if(typeof drawControl==="function"){drawControl()}add_listeners();screen_saver_start()}else{fulltree.setxyr3r(40,widthres-40,40,heightres-40);wsinit=ws;Reset();add_listeners();if(typeof drawControl==="function"){drawControl()}}}nowloading=false}
function search_init(a){global_anim_speed=100/zspeed;if(a>0){to_leaf=-1;to_index=a}else{to_leaf=1;to_index=-a}fulltree.cleartarget();fulltree.target_by_code(to_leaf,to_index);if(init=="zoom"){Resize_only();fulltree.setxyr3r(40,widthres-40,40,heightres-40);wsinit=ws;if(typeof drawControl==="function"){drawControl()}perform_flight_animation2()}else{if(init=="pzoom"){Resize_only();fulltree.setxyr3r(40,widthres-40,40,heightres-40);wsinit=ws;fulltree.deanchor();fulltree.move(40,widthres-40,40,heightres-40);introlock=true;click2zoomnum=zspeed;var b=Math.pow(10,zfact);ws=ws/b;xp=widthres/2+(xp-widthres/2)/b;yp=heightres/2+(yp-heightres/2)/b;perform_flight_animation2()}else{Resize_only();fulltree.setxyr3r(40,widthres-40,40,heightres-40);wsinit=ws;fulltree.deanchor();fulltree.move(40,widthres-40,40,heightres-40);draw2()}}add_listeners()}

var pic_vect_l=new Array;
var pic_loading_l=new Array;
var pic_pos_l=new Array;
var pic_cache_l=new Array;
var pic_pos_recyc_l=new Array;
var pic_recycler_l=new Array;
var cache_size_l=40;
var top_cache_size_l=30;
var pic_vect_s=new Array;
var pic_loading_s=new Array;
var pic_pos_s=new Array;
var pic_cache_s=new Array;
var pic_pos_recyc_s=new Array;
var pic_recycler_s=new Array;
var cache_size_s=80;
var top_cache_size_s=50;

function load_image_l(e){if(e&&(e>0)&&((mc_key_l[data_pic_col])&&(metadata.leaf_meta[e][mc_key_l[data_pic_col]]))){var f=metadata.leaf_meta[e][mc_key_l[data_pic_col]];if(f){if((pic_vect_l[e]<0)){if(!pic_loading_l[e]){var c=pic_recycler_l[pic_recycler_l.length-1];var d=2;while(pic_loading_l[pic_pos_l[c]]){c=pic_recycler_l[pic_recycler_l.length-d];if(d>=(pic_recycler_l.length-top_cache_size_l)){d=1}else{d++}}if((pic_pos_l[c])&&(pic_pos_l[c]>0)){pic_vect_l[pic_pos_l[c]]=-1;pic_pos_l[c]=null;pic_cache_l[c]=null;pic_recycler_l[pic_pos_recyc_l[c]]=null}for(jj=pic_pos_recyc_l[c];jj>0;jj--){pic_pos_recyc_l[pic_recycler_l[jj-1]]++;pic_recycler_l[jj]=pic_recycler_l[jj-1]}pic_recycler_l[0]=c;pic_pos_recyc_l[c]=0;pic_loading_l[e]=true;pic_vect_l[e]=null;pic_pos_l[c]=null;pic_cache_l[c]=new Image();pic_cache_l[c].onload=function(){pic_vect_l[e]=c;pic_pos_l[c]=e;pic_loading_l[e]=false};pic_cache_l[c].onerror=function(){pic_loading_l[e]=false};pic_cache_l[c].src=(data_path_pics+f+data_pic_ext)}}else{if((pic_pos_recyc_l[pic_vect_l[e]]>top_cache_size_l)){var b=pic_pos_recyc_l[pic_vect_l[e]];var a=pic_recycler_l[b];for(i=b;i>0;i--){pic_pos_recyc_l[pic_recycler_l[i-1]]++;pic_recycler_l[i]=pic_recycler_l[i-1]}pic_recycler_l[0]=a;pic_pos_recyc_l[a]=0}}}}}
function load_image_s(e){if(e&&(e>0)&&((mc_key_l[data_pic_col])&&(metadata.leaf_meta[e][mc_key_l[data_pic_col]]))){var f=metadata.leaf_meta[e][mc_key_l[data_pic_col]];if(f){if((pic_vect_s[e]<0)){if(!pic_loading_s[e]){var c=pic_recycler_s[pic_recycler_s.length-1];var d=2;while(pic_loading_s[pic_pos_s[c]]){c=pic_recycler_s[pic_recycler_s.length-d];if(d>=(pic_recycler_s.length-top_cache_size_s)){d=1}else{d++}}if((pic_pos_s[c])&&(pic_pos_s[c]>0)){pic_vect_s[pic_pos_s[c]]=-1;pic_pos_s[c]=null;pic_cache_s[c]=null;pic_recycler_s[pic_pos_recyc_s[c]]=null}for(jj=pic_pos_recyc_s[c];jj>0;jj--){pic_pos_recyc_s[pic_recycler_s[jj-1]]++;pic_recycler_s[jj]=pic_recycler_s[jj-1]}pic_recycler_s[0]=c;pic_pos_recyc_s[c]=0;pic_loading_s[e]=true;pic_vect_s[e]=null;pic_pos_s[c]=null;pic_cache_s[c]=new Image();pic_cache_s[c].onload=function(){pic_vect_s[e]=c;pic_pos_s[c]=e;pic_loading_s[e]=false};pic_cache_s[c].onerror=function(){pic_loading_s[e]=false};pic_cache_s[c].src=(data_path_thumbs+f+data_pic_thumb_ext)}}else{if((pic_pos_recyc_s[pic_vect_s[e]]>top_cache_size_s)){var b=pic_pos_recyc_s[pic_vect_s[e]];var a=pic_recycler_s[b];for(i=b;i>0;i--){pic_pos_recyc_s[pic_recycler_s[i-1]]++;pic_recycler_s[i]=pic_recycler_s[i-1]}pic_recycler_s[0]=a;pic_pos_recyc_s[a]=0}}}}}
function makepic_vect2(){pic_vect_l.length=(metadata.leaf_meta).length;pic_loading_l.length=(metadata.leaf_meta).length;for(i=0;i<pic_vect_l.length;i++){pic_vect_l[i]=-1;pic_loading_l[i]=false}pic_cache_l.length=cache_size_l;pic_recycler_l.length=cache_size_l;pic_pos_l.length=cache_size_l;pic_pos_recyc_l.length=cache_size_l;for(i=0;i<pic_recycler_l.length;i++){pic_recycler_l[i]=i;pic_pos_recyc_l[i]=i;pic_cache_l[i]=null;pic_pos_l[i]=null}pic_vect_s.length=(metadata.leaf_meta).length;pic_loading_s.length=(metadata.leaf_meta).length;for(i=0;i<pic_vect_s.length;i++){pic_vect_s[i]=-1;pic_loading_s[i]=false}pic_cache_s.length=cache_size_s;pic_recycler_s.length=cache_size_s;pic_pos_s.length=cache_size_s;pic_pos_recyc_s.length=cache_size_s;for(i=0;i<pic_recycler_s.length;i++){pic_recycler_s[i]=i;pic_pos_recyc_s[i]=i;pic_cache_s[i]=null;pic_pos_s[i]=null}}

var thisSound=new Audio;
var nowplaying=null;
var justplayednew=false;

function play_sound(a){if(((mc_key_l.sound)&&(metadata.leaf_meta[a][mc_key_l.sound]))&&(metadata.leaf_meta[a][mc_key_l.sound]=="1")){if((thisSound.duration)&&(thisSound.currentTime<thisSound.duration)){if(nowplaying!=a){thisSound.pause;thisSound.setAttribute("src",(data_path_sounds+metadata.leaf_meta[a][mc_key_l.latin]+".mp3"));thisSound.play();nowplaying=a;last_played=a;justplayednew=true;fulltree.check_sound()}}else{thisSound.setAttribute("src",(data_path_sounds+metadata.leaf_meta[a][mc_key_l.latin]+".mp3"));thisSound.play();nowplaying=a;last_played=a;justplayednew=true;fulltree.check_sound()}}}
midnode.prototype.check_sound=function(){this.playing_sound=false;if(this.child1){this.playing_sound=(this.child1.check_sound()|this.child2.check_sound())}else{if(nowplaying&&(nowplaying==this.metacode)){this.playing_sound=true}}return(this.playing_sound)};

midnode.prototype.soundsort=function(){if(this.child1){this.num_sounds=(this.child1.soundsort()+this.child2.soundsort())}else{if(((mc_key_l.sound)&&(metadata.leaf_meta[this.metacode][mc_key_l.sound]))&&(metadata.leaf_meta[this.metacode][mc_key_l.sound]=="1")){this.num_sounds=1}else{this.num_sounds=0}}return this.num_sounds};

function Resize(){Resize_only();draw2()}
function manusersearchclear(){clear_screensaver();clearTimeout(t);flying=false;flying_2=false;performclear();fulltree.clearsearch();fulltree.clearonroute();searchtext=""}
function searchfocus(){clear_screensaver()}
function userReset(){if(!nowloading){first_touch=true;touchX=[null,null];touchY=[null,null];touchhold=false;pinchhold=false;touch_click=false;last_x_touch=null;last_y_touch=null;mouse_disable=false;searchstring="";justopened=false;if(in_about){in_about=false;introlock=false;clearTimeout(about_anim)}Reset()}}
function viewReset_ns(){viewReset_b(false)}
function viewReset(){commonlabels=true;viewReset_b(true)}
function viewReset_b(a){if(!nowloading){first_touch=true;touchX=[null,null];touchY=[null,null];touchhold=false;pinchhold=false;touch_click=false;last_x_touch=null;last_y_touch=null;mouse_disable=false;justopened=false;if(in_about){in_about=false;introlock=false;clearTimeout(about_anim)}clear_screensaver();searchtext="";calculating=false;clearTimeout(t);flying=false;flying_2=false;if(a){performclear()}fulltree.deanchor();fulltree.graphref=true;fulltree.clear_leafpic_drawn();fulltree.setxyr3r(40,widthres-40,40,heightres-40);nowplaying=null;justplayednew=false;soundqueue=null;queuestop=null;tap2zoom=null;global_button_action=null;last_played=null;if(thisSound.duration){thisSound.currentTime=thisSound.duration}wsinit=ws;Resize()}}
function Reset(){clear_screensaver();ResetSS()}
function ResetSS(){if((growing)||(growingpause)){clearTimeout(t2);draw2();timelim=-3;Resize();growing=false;growingpause=false;Resize()}if(!screensaver_on){clear_screensaver()}commonlabels=true;searchtext="";calculating=false;clearTimeout(t);flying=false;flying_2=false;clearTimeout(t2);performclear();timelim=-3;fulltree.deanchor();fulltree.graphref=true;fulltree.clearsearch();fulltree.clearonroute();fulltree.setxyr3r(40,widthres-40,40,heightres-40);nowplaying=null;justplayednew=false;soundqueue=null;queuestop=null;tap2zoom=null;global_button_action=null;last_played=null;if(thisSound.duration){thisSound.currentTime=thisSound.duration}wsinit=ws;Resize()}

var clicking=false;
var mousehold=false;
var mouseX;
var mouseY;
var oldyp;
var oldxp;
var touchX=[];
var touchY=[];
var touchID=null;
var touch_XS;
var touch_XY;
var touchhold=false;
var pinchhold=false;
var touch_button=false;
var oldws;
var touch_click=false;
var last_x_touch=null;
var last_y_touch=null;
var mouse_disable=false;
var click2zoomnum;
var global_button_action=null;
var soundqueue=null;
var queuestop=null;
var last_played=null;
var tap2zoom=null;
var first_touch=true;

function holdon(a){tree_interact();if(!mouse_disable){if(!touchhold){clearTimeout(t);flying=false;flying_2=false;mouseY=a.clientY-myCanvas.offsetTop;mouseX=a.clientX-myCanvas.offsetLeft;clicking=true;oldyp=yp;oldxp=xp;mousehold=true;draw2()}}}
function domousein(){popupin=true}
function holdoff(){if((!mouse_disable)&&(!screensaver_on)){if(soundqueue){play_sound(soundqueue);soundqueue=null}else{if(queuestop){thisSound.currentTime=thisSound.duration;nowplaying=null;queuestop=null}else{if(tap2zoom){perform_flight_animation(tap2zoom,EP_anim_length_in)}else{if(global_button_action){window.open(global_button_action)}}}}mousehold=false;clicking=false;calculating=false}mouseY=event.clientY-myCanvas.offsetTop;mouseX=event.clientX-myCanvas.offsetLeft;draw2()}
function holdoff2(){if((!mouse_disable)&&(!screensaver_on)){mousehold=false;calculating=false;mouseX=null;mouseY=null;draw2()}}
function movemouse(b){if((!mouse_disable)&&((!flying)&&(!flying_2))){domousein();if(mousehold){tree_interact();var a=(-mouseY+b.clientY-myCanvas.offsetTop);if((a<0)&&(OKup==1)){yp=oldyp+a}else{if((a>0)&&(OKdown==1)){yp=oldyp+a}else{if(a!=0){mouseY=b.clientY-myCanvas.offsetTop;oldyp=yp}}}var a=(-mouseX+b.clientX-myCanvas.offsetLeft);if((a<0)&&(OKleft==1)){xp=oldxp+a}else{if((a>0)&&(OKright==1)){xp=oldxp+a}else{if(a!=0){mouseX=b.clientX-myCanvas.offsetLeft;oldxp=xp}}}if(Math.pow(yp-oldyp,2)>9){clicking=false}if(Math.pow(xp-oldxp,2)>9){clicking=false}draw2()}else{mouseY=b.clientY-myCanvas.offsetTop;mouseX=b.clientX-myCanvas.offsetLeft;draw2()}}else{mouse_disable=false}}
function touch_start(a){first_touch=false;touch_XS=null;touch_YS=null;a.preventDefault();soundqueue=null;queuestop=null;tap2zoom=null;global_button_action=null;if(in_about){in_about=false;introlock=false;clearTimeout(about_anim)}mouse_disable=true;holdoff();justopened=false;clearTimeout(t);flying=false;flying_2=false;tree_interact();if(a.targetTouches.length>1){touch_click=false;if(a.targetTouches.length==2){touch_button=false;soundqueue=null;queuestop=null;tap2zoom=null;global_button_action=null;oldyp=yp;oldxp=xp;oldws=ws;touchhold=false;pinchhold=true;var b=a.targetTouches[0];touchX[0]=b.pageX-myCanvas.offsetLeft;touchY[0]=b.pageY-myCanvas.offsetTop;touchID=b.identifier;b=a.targetTouches[1];touchX[1]=b.pageX-myCanvas.offsetLeft;touchY[1]=b.pageY-myCanvas.offsetTop;draw2()}}else{if(a.targetTouches.length==1){soundqueue=null;queuestop=null;tap2zoom=null;global_button_action=null;oldyp=yp;oldxp=xp;touchhold=true;pinchhold=false;var b=a.targetTouches[0];touchX[0]=b.pageX-myCanvas.offsetLeft;touchY[0]=b.pageY-myCanvas.offsetTop;touchID=b.identifier;last_x_touch=touchX[0];last_y_touch=touchY[0];touch_XS=touchX[0];touch_YS=touchY[0];draw2();touch_click=true;draw2()}}}
function touch_move(b){if(!first_touch){mouse_disable=true;b.preventDefault();clearTimeout(t);flying=false;flying_2=false;tree_interact();if(b.targetTouches.length>1){last_x_touch=null;last_y_touch=null;if(b.targetTouches.length==2){soundqueue=null;queuestop=null;tap2zoom=null;var e=b.targetTouches[0];if((e.identifier!=touchID)&&(b.targetTouches[1].identifier==touchID)){e=b.targetTouches[1]}yp=oldyp+(-touchY[0]+e.pageY-myCanvas.offsetTop);xp=oldxp+(-touchX[0]+e.pageX-myCanvas.offsetLeft);var a=e.pageX-myCanvas.offsetLeft;var d=e.pageY-myCanvas.offsetTop;var c;zoom_num=Math.pow((((touchX[0]-touchX[1])*(touchX[0]-touchX[1]))+((touchY[0]-touchY[1])*(touchY[0]-touchY[1]))),0.5);zoom_den=Math.pow((((b.targetTouches[0].pageX-b.targetTouches[1].pageX)*(b.targetTouches[0].pageX-b.targetTouches[1].pageX))+((b.targetTouches[0].pageY-b.targetTouches[1].pageY)*(b.targetTouches[0].pageY-b.targetTouches[1].pageY))),0.5);if(zoom_den>0){c=(zoom_num)/(zoom_den);ws=oldws/c;xp=a+(xp-a)/c;yp=d+(yp-d)/c}draw2()}}else{if(b.targetTouches.length==1){var e=b.targetTouches[0];if(touch_button){last_x_touch=e.pageX-myCanvas.offsetLeft;last_y_touch=e.pageY-myCanvas.offsetTop}else{if(touchID==e.identifier){yp=oldyp+(-touchY[0]+e.pageY-myCanvas.offsetTop);xp=oldxp+(-touchX[0]+e.pageX-myCanvas.offsetLeft);if(Math.pow(yp-oldyp,2)>9){touch_click=false}if(Math.pow(xp-oldxp,2)>9){touch_click=false}last_x_touch=e.pageX-myCanvas.offsetLeft;last_y_touch=e.pageY-myCanvas.offsetTop}else{soundqueue=null;queuestop=null;tap2zoom=null;global_button_action=null;oldyp=yp;oldxp=xp;touchhold=true;pinchhold=false;touchX[0]=e.pageX-myCanvas.offsetLeft;touchY[0]=e.pageY-myCanvas.offsetTop;touchID=e.identifier;last_x_touch=touchX[0];last_y_touch=touchY[0]}}draw2()}}}}
function touch_end(a){if(!first_touch){mouse_disable=true;a.preventDefault();if(a.targetTouches.length==0){if(soundqueue){play_sound(soundqueue);soundqueue=null;last_x_touch=null;last_y_touch=null}else{if(queuestop){thisSound.currentTime=thisSound.duration;nowplaying=null;queuestop=null}else{if(tap2zoom){perform_flight_animation(tap2zoom,EP_anim_length_in)}else{if(global_button_action){window.open(global_button_action)}}}}touch_button=false;touchhold=false;pinchhold=false;last_x_touch=null;last_y_touch=null;soundqueue=null;tap2zoom=null;global_button_action=null;queuestop=null;touch_click=false;if(!((((fulltree).rvar*(fulltree.hxmax-fulltree.hxmin))>(widthres*0.5))||(((fulltree).rvar*(fulltree.hymax-fulltree.hymin))>(heightres*0.5)))){perform_flight_animation(1,EP_anim_length_in/40)}else{draw2()}}else{touch_click=false;if(a.targetTouches.length==1){soundqueue=null;queuestop=null;
tap2zoom=null;global_button_action=null;oldyp=yp;oldxp=xp;touchhold=true;pinchhold=false;var b=a.targetTouches[0];touchX[0]=b.pageX-myCanvas.offsetLeft;touchY[0]=b.pageY-myCanvas.offsetTop;touchID=b.identifier;last_x_touch=touchX[0];last_y_touch=touchY[0];draw2()}if(a.targetTouches.length==2){soundqueue=null;tap2zoom=null;global_button_action=null;queuestop=null;last_x_touch=null;last_y_touch=null;touch_button=false;oldyp=yp;oldxp=xp;oldws=ws;touchhold=false;pinchhold=true;var b=a.targetTouches[0];touchX[0]=b.pageX-myCanvas.offsetLeft;touchY[0]=b.pageY-myCanvas.offsetTop;touchID=b.identifier;b=a.targetTouches[1];touchX[1]=b.pageX-myCanvas.offsetLeft;touchY[1]=b.pageY-myCanvas.offsetTop;draw2()}}}}

var timeLastScroll=new Date().getTime();

function mousewheel(b){b.preventDefault();b.stopPropagation();if(in_about){in_about=false;introlock=false;clearTimeout(about_anim)}mouse_disable=false;tree_interact();justopened=false;if(!calculating){clearTimeout(t);flying=false;flying_2=false;if(!mousehold){var d=0;if("wheelDelta" in b){d=b.wheelDelta}else{d=-b.detail/2}var c=sensitivity;var a=(new Date().getTime());if((a-timeLastScroll)<40){c=Math.pow(c,((a-timeLastScroll)/40))}timeLastScroll=a;if((parseFloat(d))>0){calculating=true;zoomin(b,c)}else{calculating=true;zoomout(b,c)}}calculating=false}}
function calcfalse(){calculating=false}
function zoomin(a,b){tree_interact();clearTimeout(t);mouseY=a.clientY-myCanvas.offsetTop;mouseX=a.clientX-myCanvas.offsetLeft;flying=false;flying_2=false;if((OKzoom==1)&&(OKrlim==1)){ws=ws/b;xp=mouseX+(xp-mouseX)/b;yp=mouseY+(yp-mouseY)/b}draw2()}
function zoomout(a,b){tree_interact();mouseY=a.clientY-myCanvas.offsetTop;mouseX=a.clientX-myCanvas.offsetLeft;clearTimeout(t);flying=false;flying_2=false;if((((fulltree).rvar*(fulltree.hxmax-fulltree.hxmin))>(widthres*0.7))||(((fulltree).rvar*(fulltree.hymax-fulltree.hymin))>(heightres*0.7))){ws=ws*b;xp=mouseX+(xp-mouseX)*b;yp=mouseY+(yp-mouseY)*b;draw2()}}

var touch_click2zoom_to;

function tree_interact(){doingupzoom=false;clear_screensaver();closeAll()}
function special_resize(){tree_interact();clearTimeout(t);flying=false;flying_2=false;Resize_only();draw2()}
function click2zoom(){tree_interact();clearTimeout(t);flying=false;flying_2=false;if((OKzoom==1)&&(OKrlim==1)){ws=ws/sensitivity3;xp=mouseX+(xp-mouseX)/sensitivity3;yp=mouseY+(yp-mouseY)/sensitivity3}draw2();click2zoomnum--;if(click2zoomnum>=0){t=setTimeout("click2zoom()",33)}}
function CZoomin(){tree_interact();if(zoominnum>0){zoominnum--}click2zoomnum=4;CZoomin2()}
function CZoomout(){tree_interact();if(zoomoutnum>0){zoomoutnum--}click2zoomnum=4;CZoomout2()}
function BZoomin(){tree_interact();if(zoominnum>0){zoominnum--}click2zoomnum=4;BZoomin2()}
function BZoomout(){tree_interact();if(zoomoutnum>0){zoomoutnum--}click2zoomnum=4;BZoomout2()}
function Bzoomup(){if(doingupzoom==false){doingupzoom=true}if(uplocvect&&(uplocvect.length>0)){if(!(perform_flight_animation(uplocvect[uplocvect.length-1],EP_anim_length_in*2))){uplocvect.length-=1;Bzoomup()}else{uplocvect.length-=1}}else{perform_flight_animation(fulltree.metacode,EP_anim_length_in*2)}}
function CZoomin2(){tree_interact();clearTimeout(t);flying=false;flying_2=false;if((OKzoom==1)&&(OKrlim==1)){ws=ws/sensitivity2;xp=mouseX+(xp-mouseX)/sensitivity2;yp=mouseY+(yp-mouseY)/sensitivity2}draw2();click2zoomnum--;if(click2zoomnum>=0){t=setTimeout("CZoomin2()",33)}}
function CZoomout2(){tree_interact();clearTimeout(t);flying=false;flying_2=false;if((((fulltree).rvar*(fulltree.hxmax-fulltree.hxmin))>(widthres*0.7))||(((fulltree).rvar*(fulltree.hymax-fulltree.hymin))>(heightres*0.7))){ws=ws*sensitivity2;xp=widthres/2+(xp-widthres/2)*sensitivity2;yp=heightres/2+(yp-heightres/2)*sensitivity2;draw2()}click2zoomnum--;if(click2zoomnum>=0){t=setTimeout("CZoomout2()",33)}}
function BZoomin2(){tree_interact();clearTimeout(t);flying=false;flying_2=false;if((OKzoom==1)&&(OKrlim==1)){ws=ws/sensitivity2;xp=widthres/2+(xp-widthres/2)/sensitivity2;yp=heightres/2+(yp-heightres/2)/sensitivity2}draw2();click2zoomnum--;if(click2zoomnum>=0){t=setTimeout("BZoomin2()",33)}}
function BZoomout2(){tree_interact();clearTimeout(t);flying=false;flying_2=false;if((((fulltree).rvar*(fulltree.hxmax-fulltree.hxmin))>(widthres*0.7))||(((fulltree).rvar*(fulltree.hymax-fulltree.hymin))>(heightres*0.7))){ws=ws*sensitivity2;xp=widthres/2+(xp-widthres/2)*sensitivity2;yp=heightres/2+(yp-heightres/2)*sensitivity2;draw2()}click2zoomnum--;if(click2zoomnum>=0){t=setTimeout("BZoomout2()",33)}}
function zoomout_animation(){if((((fulltree).rvar*(fulltree.hxmax-fulltree.hxmin))>(widthres*0.001))||(((fulltree).rvar*(fulltree.hymax-fulltree.hymin))>(heightres*0.001))){ws=ws*screen_saver.zosens;xp=widthres/2+(xp-widthres/2)*screen_saver.zosens;yp=heightres/2+(yp-heightres/2)*screen_saver.zosens;draw2();t=setTimeout("zoomout_animation()",50)}else{screen_saver_preaction()}}
function viewoptions(){if(!nowloading){if(in_about){in_about=false;introlock=false;clearTimeout(about_anim)}clear_screensaver();justopened=false;if(commonlabels){commonlabels=false}else{commonlabels=true}justopened=false;clearTimeout(t);flying=false;flying_2=false;performclear();fulltree.clearsearch();fulltree.clearonroute();searchtext="";draw2()}}
function growoptions(){if(!nowloading){if(in_about){in_about=false;introlock=false;clearTimeout(about_anim)}clear_screensaver();justopened=false;if(!growing){viewReset();growplay()}}}
function form_change(){if(!nowloading){if(in_about){in_about=false;introlock=false;clearTimeout(about_anim)}shapechanged=true;clearTimeout(t);clear_screensaver();flying=false;flying_2=false;if(viewtype==1){viewtype=2}else{if(viewtype==2){viewtype=3}else{if(viewtype==3){viewtype=4}else{viewtype=1}}}draw_loading();setTimeout("form_change2()",1)}}
function form_change2(){update_form();viewReset();if(screensaver_on){setTimeout("screen_saver_postaction2()",1)}else{Resize()}}
function autotext_(f,d,b,a,c,e){if(f){autotext(false,"italic",d,b,a,c,e,context,0)}else{autotext(false,null,d,b,a,c,e,context,0)}}
function autotext2_(f,d,b,a,c,e){if(f){autotext2(false,"italic",d,b,a,c,e,context,0)}else{autotext2(false,null,d,b,a,c,e,context,0)}}
function autotext3_(f,d,b,a,c,e){if(f){autotext3(false,"italic",d,b,a,c,e,context,0)}else{autotext3(false,null,d,b,a,c,e,context,0)}}
function meta2latin(b){var a="";if((mc_key_l.latin)&&(metadata.leaf_meta[b][mc_key_l.latin])){var c=(metadata.leaf_meta[b][mc_key_l.latin]).split("_");a=c[0];for(kk=1;kk<c.length;kk++){a+=(" "+c[kk])}return a}else{return null}}

var lastDrawTime=0;

function draw2(){var b=(new Date().getTime());global_button_action=null;global_auto_button=autobuttonxy();soundqueue=null;queuestop=null;tap2zoom=null;pics_unloaded=false;leaf_sound_playing=false;if(in_about){about_draw()}else{clearTimeout(timer4fps);draw3()}var a=(new Date().getTime());lastDrawTime=(a-b);if(lastDrawTime>100){threshold+=0.5}if(lastDrawTime<20){threshold-=0.5}if(threshold<1){threshold=1}if(threshold>12){threshold=12}}

var leaf_sound_playing=false;
var syswatch;

function draw3_RAC(c){if(typeof drawControl==="function"){drawControl()}clearTimeout(syswatch);if(!in_about){counter4pfs++;fulltree.drawreg(xp,yp,220*ws);if(((((ws>100)||(ws<0.01))&&((!mousehold)&&((!touchhold)&&(!pinchhold)&&(!touch_button)))&&((flying==false)&&(flying_2==false))))||c){fulltree.reanchor();fulltree.drawreg(xp,yp,220*ws);latest_ws=ws;if((screensaver_on&&(viewtype!=2))||(flying&&(viewtype!=2))){continue_flyB()}}context.clearRect(0,0,widthres,heightres);if(backgroundcolor){context.fillStyle=backgroundcolor;context.fillRect(0,0,widthres,heightres)}reset_MR();fulltree.draw();var b=locationtxt;var a=locationvect;locationtxt="";locationvect=[];locationvect_index=[];uplocation=null;lastuplocation=null;fulltree.mylocation(220*ws);if(locationtxt==""){locationtxt=b;locationvect=a}if(doingupzoom==false){uplocvect=fulltree.mylocation2()}if(isoverLocation){updateLocationMenu()}fulltree.draw_signs();if(pics_unloaded){syswatch=setTimeout("draw3()",100)}else{if(((fulltree.playing_sound)&&nowplaying&&((thisSound.duration&&(thisSound.currentTime<thisSound.duration))||justplayednew))){syswatch=setTimeout("draw3()",250)}}}}
function draw3(){draw3_RAC(false)}

var credits_roll_speed=2.3;
var about_height=12;
var in_about=false;
var about_upto=null;
var about_target=null;
var about_anim;
var introlock=false;
var creditsText_pos=[];

function about_draw_anim(){if(about_upto>=(heightres*0.25-about_target)){draw2();about_upto-=credits_roll_speed;about_anim=setTimeout("about_draw_anim()",33)}else{clearTimeout(about_anim);in_about=false;introlock=false;draw2()}}
function about_draw(){context.fillStyle=backgroundcolor;context.fillRect(0,0,widthres,heightres);context.fillStyle="rgb(0,0,0)";for(i=0;i<creditsText.length;i++){if(creditsText[i][1]){autotext_(false,creditsText[i][1],widthres/2,creditsText_pos[i]+about_upto,widthres*0.8,about_height*creditsText[i][0])}}}

var partc=0.4;
var partcint=0.165;
var partl1=0.55;
var partl2=0.1;
var ratio1=0.77;
var ratio2=0.47;
var Tsize=1.1;
var Twidth=1;
var Psize=0.7;
var leafmult=3.2;
var posmult=0.9;

midnode.prototype.precalc=function(h,f,m,p){this.arca=p;var o=Math.sin(p);var b=Math.cos(p);var s=Math.sin(p+Math.PI/2);var n=Math.cos(p+Math.PI/2);var q;var u;if(this.child1){q=Math.atan2((this.child1).richness_val,(this.child2).richness_val);u=Math.atan2(Math.pow((this.child1).richness_val,0.5),Math.pow(((this.child2).richness_val),0.5))}var v=0.46;var a=0.22;var g=1/1.3;var e=1/2.25;var l=Math.sin(p+Math.PI*a);var d=Math.cos(p+Math.PI*a);var k=Math.sin(p-Math.PI*v);var c=Math.cos(p-Math.PI*v);if(this.child1){if((this.child1.richness_val)>=(this.child2.richness_val)){this.nextr1=g;this.nextr2=e;(this.child1).bezsx=-(0.3)*(b)/g;(this.child1).bezsy=-(0.3)*(o)/g;(this.child1).bezex=d;(this.child1).bezey=l;(this.child1).bezc1x=-0.3*(b)/g;(this.child1).bezc1y=-0.3*(o)/g;(this.child1).bezc2x=0.15*(b)/g;(this.child1).bezc2y=0.15*(o)/g;(this.child1).bezr=partl1;(this.child2).bezsx=-(0.3)*(b)/e;(this.child2).bezsy=-(0.3)*(o)/e;(this.child2).bezex=c;(this.child2).bezey=k;(this.child2).bezc1x=0.1*(b)/e;(this.child2).bezc1y=0.1*(o)/e;(this.child2).bezc2x=0.9*c;(this.child2).bezc2y=0.9*k;(this.child2).bezr=partl1;this.nextx1=(1.3*Math.cos(p))+(((this.bezr)-(partl1*g))/2)*n;this.nexty1=(1.3*Math.sin(p))+(((this.bezr)-(partl1*g))/2)*s;this.nextx2=(1.3*Math.cos(p))-(((this.bezr)-(partl1*e))/2)*n;this.nexty2=(1.3*Math.sin(p))-(((this.bezr)-(partl1*e))/2)*s}else{this.nextr2=g;this.nextr1=e;(this.child2).bezsx=-(0.3)*(b)/g;(this.child2).bezsy=-(0.3)*(o)/g;(this.child2).bezex=d;(this.child2).bezey=l;(this.child2).bezc1x=-0.2*(b)/g;(this.child2).bezc1y=-0.2*(o)/g;(this.child2).bezc2x=0.15*(b)/g;(this.child2).bezc2y=0.15*(o)/g;(this.child2).bezr=partl1;(this.child1).bezsx=-(0.3)*(b)/e;(this.child1).bezsy=-(0.3)*(o)/e;(this.child1).bezex=c;(this.child1).bezey=k;(this.child1).bezc1x=0.1*(b)/e;(this.child1).bezc1y=0.1*(o)/e;(this.child1).bezc2x=0.9*c;(this.child1).bezc2y=0.9*k;(this.child1).bezr=partl1;this.nextx2=(1.3*Math.cos(p))+(((this.bezr)-(partl1*g))/2)*n;this.nexty2=(1.3*Math.sin(p))+(((this.bezr)-(partl1*g))/2)*s;this.nextx1=(1.3*Math.cos(p))-(((this.bezr)-(partl1*e))/2)*n;this.nexty1=(1.3*Math.sin(p))-(((this.bezr)-(partl1*e))/2)*s}this.arcx=this.bezex;this.arcy=this.bezey;this.arcr=(this.bezr)/2;if(this.child1){if((this.child1.richness_val)>=(this.child2.richness_val)){this.child1.precalc(h+((m)*(this.nextx1)),f+(m)*(this.nexty1),m*g,p+Math.PI*a);this.child2.precalc(h+((m)*(this.nextx2)),f+(m)*(this.nexty2),m*e,p-Math.PI*v)}else{this.child2.precalc(h+((m)*(this.nextx2)),f+(m)*(this.nexty2),m*g,p+Math.PI*a);this.child1.precalc(h+((m)*(this.nextx1)),f+(m)*(this.nexty1),m*e,p-Math.PI*v)}}}else{this.arcx=this.bezex+posmult*(b);this.arcy=this.bezey+posmult*(o);this.arcr=leafmult*partc}};

midnode.prototype.precalc2=function(k,f,m,s){this.arca=s;var o=Math.sin(s);var b=Math.cos(s);var v=Math.sin(s+Math.PI/2);var n=Math.cos(s+Math.PI/2);var u;var w;if(this.child1){u=Math.atan2((this.child1).richness_val,(this.child2).richness_val);w=Math.atan2(Math.pow((this.child1).richness_val,0.5),Math.pow(((this.child2).richness_val),0.5))}var z=0.5;var a=0.2;var g=ratio1;var e=ratio2;var q;var p;if((this.richness_val>1)&&((this.child1)&&(this.child2))){if((this.child1.richness_val)>=(this.child2.richness_val)){a=0.45-(u)/Math.PI/0.5*0.449;z=0.45-(0.5-(u)/Math.PI)/0.5*0.449;g=0.3+(w)/Math.PI/0.5*0.5;e=0.3+(0.5-(w)/Math.PI)/0.5*0.5}else{z=0.45-(u)/Math.PI/0.5*0.449;a=0.45-(0.5-(u)/Math.PI)/0.5*0.449;e=0.3+(w)/Math.PI/0.5*0.5;g=0.3+(0.5-(w)/Math.PI)/0.5*0.5}}if(this.child1){q=(this.child1.richness_val)/((this.child1.richness_val)+(this.child2.richness_val));p=(this.child2.richness_val)/((this.child1.richness_val)+(this.child2.richness_val))}var l=Math.sin(s+Math.PI*a);var d=Math.cos(s+Math.PI*a);var h=Math.sin(s-Math.PI*z);var c=Math.cos(s-Math.PI*z);if(this.child1){if((this.child1.richness_val)>=(this.child2.richness_val)){this.nextr1=g;this.nextr2=e;(this.child1).bezsx=-(0.3)*(b)/g;(this.child1).bezsy=-(0.3)*(o)/g;(this.child1).bezex=d;(this.child1).bezey=l;(this.child1).bezc1x=0;(this.child1).bezc1y=0;(this.child1).bezc2x=0.9*d;(this.child1).bezc2y=0.9*l;(this.child1).bezr=partl1;(this.child2).bezsx=-(0.3)*(b)/e;(this.child2).bezsy=-(0.3)*(o)/e;(this.child2).bezex=c;(this.child2).bezey=h;(this.child2).bezc1x=0;(this.child2).bezc1y=0;(this.child2).bezc2x=0.3*c;(this.child2).bezc2y=0.3*h;(this.child2).bezr=partl1;this.nextx1=(1.3*Math.cos(s))+(((this.bezr)-(partl1*g))/2)*n;this.nexty1=(1.3*Math.sin(s))+(((this.bezr)-(partl1*g))/2)*v;this.nextx2=(1.3*Math.cos(s))-(((this.bezr)-(partl1*e))/2)*n;this.nexty2=(1.3*Math.sin(s))-(((this.bezr)-(partl1*e))/2)*v}else{this.nextr2=g;this.nextr1=e;(this.child2).bezsx=-(0.3)*(b)/g;(this.child2).bezsy=-(0.3)*(o)/g;(this.child2).bezex=d;(this.child2).bezey=l;(this.child2).bezc1x=0;(this.child2).bezc1y=0;(this.child2).bezc2x=0.9*d;(this.child2).bezc2y=0.9*l;(this.child2).bezr=partl1;(this.child1).bezsx=-(0.3)*(b)/e;(this.child1).bezsy=-(0.3)*(o)/e;(this.child1).bezex=c;(this.child1).bezey=h;(this.child1).bezc1x=0;(this.child1).bezc1y=0;(this.child1).bezc2x=0.9*c;(this.child1).bezc2y=0.9*h;(this.child1).bezr=partl1;this.nextx2=(1.3*Math.cos(s))+(((this.bezr)-(partl1*g))/2)*n;this.nexty2=(1.3*Math.sin(s))+(((this.bezr)-(partl1*g))/2)*v;this.nextx1=(1.3*Math.cos(s))-(((this.bezr)-(partl1*e))/2)*n;this.nexty1=(1.3*Math.sin(s))-(((this.bezr)-(partl1*e))/2)*v}this.arcx=this.bezex;this.arcy=this.bezey;this.arcr=(this.bezr)/2;if(this.child1){if((this.child1.richness_val)>=(this.child2.richness_val)){this.child1.precalc2(k+((m)*(this.nextx1)),f+(m)*(this.nexty1),m*g,s+Math.PI*a);this.child2.precalc2(k+((m)*(this.nextx2)),f+(m)*(this.nexty2),m*e,s-Math.PI*z)}else{this.child2.precalc2(k+((m)*(this.nextx2)),f+(m)*(this.nexty2),m*g,s+Math.PI*a);this.child1.precalc2(k+((m)*(this.nextx1)),f+(m)*(this.nexty1),m*e,s-Math.PI*z)}}}else{this.arcx=this.bezex+posmult*(b);this.arcy=this.bezey+posmult*(o);this.arcr=leafmult*partc}};

midnode.prototype.precalc4=function(h,f,m,p){this.arca=p;var o=Math.sin(p);var b=Math.cos(p);var s=Math.sin(p+Math.PI/2);var n=Math.cos(p+Math.PI/2);var q;var u;if(this.child1){q=Math.atan2((this.child1).richness_val,(this.child2).richness_val);u=Math.atan2(Math.pow((this.child1).richness_val,0.5),Math.pow(((this.child2).richness_val),0.5))}var v=0.33;var a=0.33;var g=0.61;var e=0.61;var l=Math.sin(p+Math.PI*a);var d=Math.cos(p+Math.PI*a);var k=Math.sin(p-Math.PI*v);var c=Math.cos(p-Math.PI*v);if(this.child1){if((this.child1.richness_val)>=(this.child2.richness_val)){this.nextr1=g;this.nextr2=e;(this.child1).bezsx=-(0.3)*(b)/g;(this.child1).bezsy=-(0.3)*(o)/g;(this.child1).bezex=d;(this.child1).bezey=l;(this.child1).bezc1x=-0.3*(b)/g;(this.child1).bezc1y=-0.3*(o)/g;(this.child1).bezc2x=0.15*(b)/g;(this.child1).bezc2y=0.15*(o)/g;(this.child1).bezr=partl1;(this.child2).bezsx=-(0.3)*(b)/e;(this.child2).bezsy=-(0.3)*(o)/e;(this.child2).bezex=c;(this.child2).bezey=k;(this.child2).bezc1x=0.1*(b)/e;(this.child2).bezc1y=0.1*(o)/e;(this.child2).bezc2x=0.9*c;(this.child2).bezc2y=0.9*k;(this.child2).bezr=partl1;this.nextx1=(1.3*Math.cos(p))+(((this.bezr)-(partl1*g))/2)*n;this.nexty1=(1.3*Math.sin(p))+(((this.bezr)-(partl1*g))/2)*s;this.nextx2=(1.3*Math.cos(p))-(((this.bezr)-(partl1*e))/2)*n;this.nexty2=(1.3*Math.sin(p))-(((this.bezr)-(partl1*e))/2)*s}else{this.nextr2=g;this.nextr1=e;(this.child2).bezsx=-(0.3)*(b)/g;(this.child2).bezsy=-(0.3)*(o)/g;(this.child2).bezex=d;(this.child2).bezey=l;(this.child2).bezc1x=-0.2*(b)/g;(this.child2).bezc1y=-0.2*(o)/g;(this.child2).bezc2x=0.15*(b)/g;(this.child2).bezc2y=0.15*(o)/g;(this.child2).bezr=partl1;(this.child1).bezsx=-(0.3)*(b)/e;(this.child1).bezsy=-(0.3)*(o)/e;(this.child1).bezex=c;(this.child1).bezey=k;(this.child1).bezc1x=0.1*(b)/e;(this.child1).bezc1y=0.1*(o)/e;(this.child1).bezc2x=0.9*c;(this.child1).bezc2y=0.9*k;(this.child1).bezr=partl1;this.nextx2=(1.3*Math.cos(p))+(((this.bezr)-(partl1*g))/2)*n;this.nexty2=(1.3*Math.sin(p))+(((this.bezr)-(partl1*g))/2)*s;this.nextx1=(1.3*Math.cos(p))-(((this.bezr)-(partl1*e))/2)*n;this.nexty1=(1.3*Math.sin(p))-(((this.bezr)-(partl1*e))/2)*s}this.arcx=this.bezex;this.arcy=this.bezey;this.arcr=(this.bezr)/2;if(this.child1){if((this.child1.richness_val)>=(this.child2.richness_val)){this.child1.precalc4(h+((m)*(this.nextx1)),f+(m)*(this.nexty1),m*g,p+Math.PI*a);this.child2.precalc4(h+((m)*(this.nextx2)),f+(m)*(this.nexty2),m*e,p-Math.PI*v)}else{this.child2.precalc4(h+((m)*(this.nextx2)),f+(m)*(this.nexty2),m*g,p+Math.PI*a);this.child1.precalc4(h+((m)*(this.nextx1)),f+(m)*(this.nexty1),m*e,p-Math.PI*v)}}}else{this.arcx=this.bezex+posmult*(b);this.arcy=this.bezey+posmult*(o);this.arcr=leafmult*partc}};

midnode.prototype.precalc3=function(k,f,n,v,p){this.arca=v;var s=Math.sin(v);var b=Math.cos(v);var z=Math.sin(v+Math.PI/2);var q=Math.cos(v+Math.PI/2);var w;var A;var B=0.2;var a=0.1;var g=0.85;var e=0.42;var u=false;if(!p){var B=0.1;var a=0.2;var g=0.42;var e=0.85;if(this.child1){if((this.child1.richness_val)<(this.child2.richness_val)){u=true}}}else{if(this.child1){if((this.child1.richness_val)>=(this.child2.richness_val)){u=true}}}var o=partl1;var m=partl1;var l=Math.sin(v+Math.PI*a);var d=Math.cos(v+Math.PI*a);var h=Math.sin(v-Math.PI*B);var c=Math.cos(v-Math.PI*B);if(this.child1){if(u){this.nextr1=g;this.nextr2=e;(this.child1).bezsx=-(0.3)*(b)/g;(this.child1).bezsy=-(0.3)*(s)/g;(this.child1).bezex=d;(this.child1).bezey=l;(this.child1).bezc1x=-0.3*(b)/g;(this.child1).bezc1y=-0.3*(s)/g;(this.child1).bezc2x=0.15*(b)/g;(this.child1).bezc2y=0.15*(s)/g;(this.child1).bezr=partl1;(this.child2).bezsx=-(0.3)*(b)/e;(this.child2).bezsy=-(0.3)*(s)/e;(this.child2).bezex=c;(this.child2).bezey=h;(this.child2).bezc1x=0.1*(b)/e;(this.child2).bezc1y=0.1*(s)/e;(this.child2).bezc2x=0.9*c;(this.child2).bezc2y=0.9*h;(this.child2).bezr=partl1;this.nextx1=(1.3*Math.cos(v))+(((this.bezr)-(o*g))/2)*q;this.nexty1=(1.3*Math.sin(v))+(((this.bezr)-(o*g))/2)*z;this.nextx2=(1.3*Math.cos(v))-(((this.bezr)-(m*e))/2)*q;this.nexty2=(1.3*Math.sin(v))-(((this.bezr)-(m*e))/2)*z}else{this.nextr2=g;this.nextr1=e;(this.child2).bezsx=-(0.3)*(b)/g;(this.child2).bezsy=-(0.3)*(s)/g;(this.child2).bezex=d;(this.child2).bezey=l;(this.child2).bezc1x=-0.2*(b)/g;(this.child2).bezc1y=-0.2*(s)/g;(this.child2).bezc2x=0.15*(b)/g;(this.child2).bezc2y=0.15*(s)/g;(this.child2).bezr=partl1;(this.child1).bezsx=-(0.3)*(b)/e;(this.child1).bezsy=-(0.3)*(s)/e;(this.child1).bezex=c;(this.child1).bezey=h;(this.child1).bezc1x=0.1*(b)/e;(this.child1).bezc1y=0.1*(s)/e;(this.child1).bezc2x=0.9*c;(this.child1).bezc2y=0.9*h;(this.child1).bezr=partl1;this.nextx2=(1.3*Math.cos(v))+(((this.bezr)-(o*g))/2)*q;this.nexty2=(1.3*Math.sin(v))+(((this.bezr)-(o*g))/2)*z;this.nextx1=(1.3*Math.cos(v))-(((this.bezr)-(m*e))/2)*q;this.nexty1=(1.3*Math.sin(v))-(((this.bezr)-(m*e))/2)*z}this.arcx=this.bezex;this.arcy=this.bezey;this.arcr=(this.bezr)/2;if(this.child1){if(u){this.child1.precalc3(k+((n)*(this.nextx1)),f+(n)*(this.nexty1),n*g,v+Math.PI*a,!p);this.child2.precalc3(k+((n)*(this.nextx2)),f+(n)*(this.nexty2),n*e,v-Math.PI*B,!p)}else{this.child2.precalc3(k+((n)*(this.nextx2)),f+(n)*(this.nexty2),n*g,v+Math.PI*a,!p);this.child1.precalc3(k+((n)*(this.nextx1)),f+(n)*(this.nexty1),n*e,v-Math.PI*B,!p)}}}else{this.arcx=this.bezex+posmult*(b);this.arcy=this.bezey+posmult*(s);this.arcr=leafmult*partc}};

function update_form(){fulltree.drawreg(xp,yp,220*ws);fulltree.move2();fulltree.bezsx=0;fulltree.bezsy=0;fulltree.bezex=0;fulltree.bezey=-1;fulltree.bezc1x=0;fulltree.bezc1y=-0.05;fulltree.bezc2x=0;fulltree.bezc2y=-0.95;fulltree.bezr=partl1;if(viewtype==2){fulltree.precalc2(xp,yp,220*ws,Math.PI*3/2)}else{if(viewtype==3){fulltree.bezsx=-Math.sin(Math.PI*0.05);fulltree.bezsy=0;fulltree.bezex=-Math.sin(Math.PI*0.05);fulltree.bezey=-Math.cos(Math.PI*0.05);fulltree.bezc1x=-Math.sin(Math.PI*0.05);fulltree.bezc1y=-0.05;fulltree.bezc2x=-Math.sin(Math.PI*0.05);fulltree.bezc2y=-0.95;fulltree.bezr=partl1;fulltree.precalc3(xp,yp,220*ws,Math.PI*(3/2-0.05),true,true)}else{if(viewtype==4){fulltree.precalc4(xp,yp,220*ws,Math.PI*3/2)}else{fulltree.precalc(xp,yp,220*ws,Math.PI*3/2)}}}fulltree.calchorizon();fulltree.graphref=true;fulltree.reref();fulltree.deanchor();fulltree.reref();fulltree.move3(40,widthres-40,65,heightres-40)}
midnode.prototype.metacalc=function(){if(this.child1){if(mc_key_n[data_pic_col]){this.pic_file=metadata.leaf_meta[this.metacode][mc_key_n[data_pic_col]];if(this.pic_file){if(mc_key_n[data_pic_col_rating]){this.pic_qual=parseInt(metadata.leaf_meta[this.metacode][mc_key_n[data_pic_col_rating]]);if(this.pic_qual<25000){this.pic_file=null}if(Math.floor(this.pic_qual/10000)==(this.pic_qual/1000)){this.pic_qual=this.pic_qual-999;if(this.pic_qual<25000){this.pic_qual=25000}}}if((typeof this.pic_qual=="undefined")||isNaN(this.pic_qual)){this.pic_qual=25000}}}(this.child1).metacalc();(this.child2).metacalc()}else{this.cname=metadata.leaf_meta[this.metacode][mc_key_l.common_en];if(mc_key_l[data_pic_col]){this.pic_file=metadata.leaf_meta[this.metacode][mc_key_l[data_pic_col]];if(this.pic_file){if(mc_key_l[data_pic_col_rating]){this.pic_qual=parseInt(metadata.leaf_meta[this.metacode][mc_key_l[data_pic_col_rating]]);if(this.pic_qual<25000){this.pic_file=null}if(Math.floor(this.pic_qual/10000)==(this.pic_qual/1000)){this.pic_qual=this.pic_qual-999;if(this.pic_qual<25000){this.pic_qual=25000}}}if((typeof this.pic_qual=="undefined")||isNaN(this.pic_qual)){this.pic_qual=25000}}}if(mc_key_l.IUCN){this.redlist=metadata.leaf_meta[this.metacode][mc_key_l.IUCN]}if(mc_key_l.InfoTextOrURL){if(metadata.leaf_meta[this.metacode][mc_key_l.InfoTextOrURL]){this.extraleafinfo=metadata.leaf_meta[this.metacode][mc_key_l.InfoTextOrURL]}}}};

midnode.prototype.leaf_richness_calc=function(){if(this.child1){this.leaf_richness_val=(((this.child1).leaf_richness_calc())+((this.child2).leaf_richness_calc()))}else{this.leaf_richness_val=1}return(this.leaf_richness_val)};

midnode.prototype.richness_calc=function(){if(this.child1){this.richness_val=(((this.child1).richness_calc())+((this.child2).richness_calc()));if(this.name1){var a=this.name1.substr(this.name1.length-1);if(a!="_"){this.name1=this.name1.split("_").join(" ")}else{this.name1=null}}if(this.name2){var a=this.name2.substr(this.name2.length-1);if(a!="_"){this.name2=this.name2.split("_").join(" ")}else{this.name2=null}}}else{if((mc_key_l.n_spp)&&(metadata.leaf_meta[this.metacode][mc_key_l.n_spp])){this.richness_val=parseInt(metadata.leaf_meta[this.metacode][mc_key_l.n_spp])}else{this.richness_val=1}if(this.name1){var a=this.name1.substr(this.name1.length-1);if(a!="_"){if(a=="'"){this.name1=this.name1.substr(0,this.name1.length-1)}if(this.name1[0]=="'"){this.name1=this.name1.substr(1,this.name1.length)}this.name1=this.name1.split("_").join(" ")}else{this.name1=null}}if(this.name2){var a=this.name2.substr(this.name2.length-1);if(a!="_"){if(a=="'"){this.name2=this.name2.substr(0,this.name2.length-1)}if(this.name2[0]=="'"){this.name2=this.name2.substr(1,this.name2.length)}this.name2=this.name2.split("_").join(" ")}else{this.name2=null}}}return(this.richness_val)};

midnode.prototype.name_calc=function(){if(this.child1){if(((this.child1).name_calc())==((this.child2).name_calc())){this.name2=((this.child1).name2)}}return(this.name2)};

midnode.prototype.phylogeneticdiv_calc=function(){this.phylogenetic_diversity=0;if(this.child1){this.phylogenetic_diversity+=(this.child2).phylogeneticdiv_calc();this.phylogenetic_diversity+=(this.child1).phylogeneticdiv_calc()}return(this.phylogenetic_diversity+this.lengthbr)};

midnode.prototype.age_calc=function(){this.evoluni=this.lengthbr;if((this.lengthbr==0)&&(this.child1)){this.npolyt=false}else{this.npolyt=true}var a;a=(this.lengthbr);if(this.child1){(this.lengthbr)=(this.child2).age_calc();(this.lengthbr)=(this.child1).age_calc();return((a)+(this.lengthbr))}else{(this.lengthbr)=0;return(a)}};

midnode.prototype.inlabel_calc=function(a){if(this.child1){if((this.name2)&&(this.name2!=a)){this.name1=this.name2;this.child1.inlabel_calc(this.name1);this.child2.inlabel_calc(this.name1)}else{this.name2=null;this.child1.inlabel_calc(a);this.child2.inlabel_calc(a)}}};

midnode.prototype.spsort=function(b,a){if((this.child1)&&(this.leaf_richness_val>=7)){if(this.cname){this.drawsignposts_common=true;a=1}else{if(((a>=b)&&((this.leaf_richness_val>=10)))&&((this.num_pics>0))){this.drawsignposts_common=true;a=1}else{this.drawsignposts_common=false;a=a+1}}this.child1.spsort(b,a);this.child2.spsort(b,a)}else{this.drawsignposts_common=false}};

midnode.prototype.pic_calc=function(){if(this.child1){this.child1.pic_calc();this.child2.pic_calc();this.num_pics=(this.child1.num_pics+this.child2.num_pics)}else{if(this.pic_file){this.num_pics=1}else{this.num_pics=0}}};

midnode.prototype.mult=function(){var a;if(this.child1){if(this.child1.graphref){a=(this.nextr1)*(this.child1.mult())}else{if(this.child2.graphref){a=(this.nextr2)*(this.child2.mult())}else{a=1}}}else{a=1}return a};

midnode.prototype.reref=function(){if(this.onroute){this.graphref=true;if(this.child1){if(this.child1.onroute){this.child1.reref()}else{this.child1.graphref=false}if(this.child2.onroute){this.child2.reref()}else{this.child2.graphref=false}}}};

midnode.prototype.calchorizon=function(){this.hxmax=this.bezsx;this.hxmin=this.bezsx;this.hymax=this.bezsy;this.hymin=this.bezsy;if(this.hxmax<this.bezc1x){this.hxmax=this.bezc1x}if(this.hxmin>this.bezc1x){this.hxmin=this.bezc1x}if(this.hymax<this.bezc1y){this.hymax=this.bezc1y}if(this.hymin>this.bezc1y){this.hymin=this.bezc1y}if(this.hxmax<this.bezc2x){this.hxmax=this.bezc2x}if(this.hxmin>this.bezc2x){this.hxmin=this.bezc2x}if(this.hymax<this.bezc2y){this.hymax=this.bezc2y}if(this.hymin>this.bezc2y){this.hymin=this.bezc2y}if(this.hxmax<this.bezex){this.hxmax=this.bezex}if(this.hxmin>this.bezex){this.hxmin=this.bezex}if(this.hymax<this.bezey){this.hymax=this.bezey}if(this.hymin>this.bezey){this.hymin=this.bezey}this.hxmax+=this.bezr/2;this.hxmin-=this.bezr/2;this.hymax+=this.bezr/2;this.hymin-=this.bezr/2;if(this.hxmax<(this.arcx+this.arcr*1.305)){this.hxmax=(this.arcx+this.arcr*1.305)}if(this.hxmin>(this.arcx-this.arcr*1.305)){this.hxmin=(this.arcx-this.arcr*1.305)}if(this.hymax<(this.arcy+this.arcr*1.305)){this.hymax=(this.arcy+this.arcr*1.305)}if(this.hymin>(this.arcy-this.arcr*1.305)){this.hymin=(this.arcy-this.arcr*1.305)}this.gxmax=this.hxmax;this.gxmin=this.hxmin;this.gymax=this.hymax;this.gymin=this.hymin;if(this.child1){this.child1.calchorizon();this.child2.calchorizon();if(this.hxmax<(this.nextx1+this.nextr1*this.child1.hxmax)){this.hxmax=(this.nextx1+this.nextr1*this.child1.hxmax)}if(this.hxmin>(this.nextx1+this.nextr1*this.child1.hxmin)){this.hxmin=(this.nextx1+this.nextr1*this.child1.hxmin)}if(this.hymax<(this.nexty1+this.nextr1*this.child1.hymax)){this.hymax=(this.nexty1+this.nextr1*this.child1.hymax)}if(this.hymin>(this.nexty1+this.nextr1*this.child1.hymin)){this.hymin=(this.nexty1+this.nextr1*this.child1.hymin)}if(this.hxmax<(this.nextx2+this.nextr2*this.child2.hxmax)){this.hxmax=(this.nextx2+this.nextr2*this.child2.hxmax)}if(this.hxmin>(this.nextx2+this.nextr2*this.child2.hxmin)){this.hxmin=(this.nextx2+this.nextr2*this.child2.hxmin)}if(this.hymax<(this.nexty2+this.nextr2*this.child2.hymax)){this.hymax=(this.nexty2+this.nextr2*this.child2.hymax)}if(this.hymin>(this.nexty2+this.nextr2*this.child2.hymin)){this.hymin=(this.nexty2+this.nextr2*this.child2.hymin)}}};

midnode.prototype.reanchor=function(){if(this.dvar){this.graphref=true;if(((this.gvar)||(!(this.child1)))||((this.rvar/220>0.01)&&(this.rvar/220<100))){xp=this.xvar;yp=this.yvar;ws=this.rvar/220;if(this.child1){this.child2.deanchor();this.child1.deanchor()}}else{if(this.child1.dvar){this.child1.reanchor();this.child2.deanchor()}else{this.child2.reanchor();this.child1.deanchor()}}}};

midnode.prototype.deanchor=function(){if(this.graphref){if(this.child1){this.child1.deanchor();this.child2.deanchor()}this.graphref=false}};

midnode.prototype.clear_leafpic_drawn=function(){this.leafpic_drawn=false;if(this.child1){this.child1.clear_leafpic_drawn();this.child2.clear_leafpic_drawn()}};

midnode.prototype.count_dvar=function(){var a=0;if(this.child1){a=a+(this.child1).count_dvar();a=a+(this.child2).count_dvar()}if(this.dvar){a=a+1}return(a)};

midnode.prototype.count_gvar=function(){var a=0;if(this.child1){a=a+(this.child1).count_gvar();a=a+(this.child2).count_gvar()}if(this.gvar){a=a+1}return(a)};

midnode.prototype.count_gdvar=function(){var a=0;if(this.child1){if(this.child1.dvar){a=a+(this.child1).count_gdvar()}if(this.child2.dvar){a=a+(this.child2).count_gdvar()}}if(this.gvar){a=a+1}return(a)};

midnode.prototype.drawreg=function(a,c,b){if(this.child1){if(this.child1.graphref){this.child1.drawreg(a,c,b);this.rvar=this.child1.rvar/this.nextr1;this.xvar=this.child1.xvar-this.rvar*this.nextx1;this.yvar=this.child1.yvar-this.rvar*this.nexty1;this.dvar=false;this.child2.gvar=false;this.child2.dvar=false;if(((!((((this.xvar+(this.rvar*this.hxmax))<0)||((this.xvar+(this.rvar*this.hxmin))>widthres))||(((this.yvar+(this.rvar*this.hymax))<0)||((this.yvar+(this.rvar*this.hymin))>heightres)))))){if(this.rvar>threshold){this.child2.drawreg2(this.xvar+((this.rvar)*(this.nextx2)),this.yvar+(this.rvar)*(this.nexty2),this.rvar*this.nextr2)}if(((((this.xvar+(this.rvar*this.gxmax))<0)||((this.xvar+(this.rvar*this.gxmin))>widthres))||(((this.yvar+(this.rvar*this.gymax))<0)||((this.yvar+(this.rvar*this.gymin))>heightres)))){this.gvar=false}else{this.gvar=true;this.dvar=true}if(this.rvar<=threshold){this.child1.gvar=false;this.child2.gvar=false;this.child1.dvar=false;this.child2.dvar=false}}else{this.gvar=false}if((this.child1.dvar)||(this.child2.dvar)){this.dvar=true}}else{if(this.child2.graphref){this.child2.drawreg(a,c,b);this.rvar=this.child2.rvar/this.nextr2;this.xvar=this.child2.xvar-this.rvar*this.nextx2;this.yvar=this.child2.yvar-this.rvar*this.nexty2;this.dvar=false;this.child1.gvar=false;this.child1.dvar=false;if(((!((((this.xvar+(this.rvar*this.hxmax))<0)||((this.xvar+(this.rvar*this.hxmin))>widthres))||(((this.yvar+(this.rvar*this.hymax))<0)||((this.yvar+(this.rvar*this.hymin))>heightres)))))){if(this.rvar>threshold){this.child1.drawreg2(this.xvar+((this.rvar)*(this.nextx1)),this.yvar+(this.rvar)*(this.nexty1),this.rvar*this.nextr1)}if(((((this.xvar+(this.rvar*this.gxmax))<0)||((this.xvar+(this.rvar*this.gxmin))>widthres))||(((this.yvar+(this.rvar*this.gymax))<0)||((this.yvar+(this.rvar*this.gymin))>heightres)))){this.gvar=false}else{this.gvar=true;this.dvar=true}if(this.rvar<=threshold){this.child1.gvar=false;this.child2.gvar=false;this.child1.dvar=false;this.child2.dvar=false}}else{this.gvar=false}if((this.child1.dvar)||(this.child2.dvar)){this.dvar=true}}else{this.drawreg2(a,c,b)}}}else{this.drawreg2(a,c,b)}};

midnode.prototype.drawreg2=function(a,c,b){this.xvar=a;this.yvar=c;this.rvar=b;this.dvar=false;if(((!((((a+(b*this.hxmax))<0)||((a+(b*this.hxmin))>widthres))||(((c+(b*this.hymax))<0)||((c+(b*this.hymin))>heightres)))))){if(this.child1){if(b>threshold){this.child1.drawreg2(a+((b)*(this.nextx1)),c+(b)*(this.nexty1),b*this.nextr1);this.child2.drawreg2(a+((b)*(this.nextx2)),c+(b)*(this.nexty2),b*this.nextr2)}else{this.child1.gvar=false;this.child1.dvar=false;this.child2.gvar=false;this.child2.dvar=false}if((this.child1.dvar)||(this.child2.dvar)){this.dvar=true}}if(((((a+(b*this.gxmax))<0)||((a+(b*this.gxmin))>widthres))||(((c+(b*this.gymax))<0)||((c+(b*this.gymin))>heightres)))){this.gvar=false}else{this.gvar=true;this.dvar=true}}else{this.gvar=false}};

midnode.prototype.search=function(c){var a=null;if(this.child1){if(this.name1){a=this.name1}}else{if(this.name1){if(this.name2){a=this.name2+" "+this.name1}else{a=this.name1}}else{if(this.name2){a=this.name2}else{a=null}}}var e=0;if(this.cname){e=Math.max(search_match(this.cname,c)*3+2,search_match(this.cname,pluralize(c))*3+1)}if(a){e=Math.max(e,search_match(a,c)*3)}if(this.child1){var d=(this.child1).search(c);var f=(this.child2).search(c);var b=d.concat(f);if(e>2){b=b.concat([[this.cname,a,this.metacode,this.richness_val,e]])}return(b)}else{if(e>2){return([[this.cname,a,-this.metacode,this.richness_val,e]])}else{return([])}}};

pluralize=function(c){var b=c.substr(c.length-1);var d=c.substr(c.length-2,1);var a=c.substr(c.length-2,2);if((b=="y")&&(vowel(d)==false)){return(c.substr(0,c.length-1)+"ies")}else{if((b=="s")||(b=="x")||(b=="z")){return(c+"es")}else{if((a=="ch")||(a=="sh")){return(c+"es")}else{return(c+"s")}}}};

vowel=function(a){if(a=="a"){return(true)}else{if(a=="e"){return(true)}else{if(a=="i"){return(true)}else{if(a=="o"){return(true)}else{if(a=="u"){return(true)}else{return(false)}}}}}};

search_match=function(a,e){if(a==e){return(10)}else{var h=a.toLowerCase();var g=e.toLowerCase();if(h==g){return(9)}else{var c=h.replace(/[^\w\s]|_/g,"");var d=g.replace(/[^\w\s]|_/g,"");if(c==d){return(8)}else{var b=h.search(g);if(b!=-1){if(b==0){if(/\s/g.test(h[b+g.length])){return(6)}else{return(5)}}else{if((b+g.length)==h.length){if(/\s/g.test(h[b-1])){return(7)}else{return(6)}}else{if((/\s/g.test(h[b-1]))&&(/\s/g.test(h[b+g.length]))){return(4)}else{return(3)}}}}else{var k=h.replace(/[^\w]|_/g,"");var f=g.replace(/[^\w]|_/g,"");b=k.search(f);if(b!=-1){if(b==0){return(2)}else{return(0)}}else{return(0)}}}}}};

full_search=function(c){var a=fulltree.search(c);var d=false;while(d!=true){d=true;for(var b=1;b<a.length;b++){if(compare(a[b],a[b-1])==false){d=false;var e=a[b-1];a[b-1]=a[b];a[b]=e}}}return(a)};

compare=function(b,a){if(b[4]<a[4]){return(true)}else{if(b[4]>a[4]){return(false)}else{if(b[3]<=a[3]){return(true)}else{return(false)}}}};

midnode.prototype.randomsearch=function(){this.targeted=true;var b=Math.random();if(this.child1){if(b<(((this.child1).richness_val*2-1)/(this.richness_val*2-1))){var a=Math.random();if((a<0.85)||(this.richness_val>10000)){this.child1.randomsearch()}}else{if(b<((this.richness_val*2-2)/(this.richness_val*2-1))){var a=Math.random();if((a<0.85)||(this.richness_val>10000)){this.child2.randomsearch()}}}}};

midnode.prototype.randomsearch_=function(){this.targeted=true;var a=Math.random();if(this.child1){if(a<(((this.child1).num_good_pics)/(this.num_good_pics))){this.child1.randomsearch_()}else{this.child2.randomsearch_()}}};

midnode.prototype.randomsearch_s=function(){this.targeted=true;var a=Math.random();if(this.child1){if(a<(((this.child1).num_sounds)/(this.num_sounds))){(this.child1.randomsearch_s())}else{(this.child2.randomsearch_s())}}else{play_sound(this.metacode)}};

midnode.prototype.randomsound=function(){var a=Math.random();if(this.num_sounds<=0){return null}else{if(this.child1){if(a<(((this.child1).num_sounds)/(this.num_sounds))){return(this.child1.randomsound())}else{return(this.child2.randomsound())}}else{return(this.metacode)}}};

midnode.prototype.searchtarget=function(){var a=-1;if((this.searchin-this.searchinpast)>0){if(((this.searchin-this.searchinpast)/(this.richness_val))>0.7){this.targeted=true;if(this.child1){this.child1.targeted=false;this.child2.targeted=false}if((this.child1)&&(((this.child1).searchin>0)||((this.child2).searchin>0))){if((((this.child1).searchin)-((this.child1).searchinpast))<=0){var c=(this.child2).searchtarget();a=c}else{if((((this.child2).searchin)-((this.child2).searchinpast))<=0){var c=(this.child1).searchtarget();a=c}else{a=this.searchin}}}else{a=this.searchin}}else{if(this.child1){var d=this.child1.searchtarget();var b=this.child2.searchtarget()}if(d>b){this.child1.targeted=true;this.child2.targeted=false;a=d}else{this.child2.targeted=true;this.child1.targeted=false;a=b}}}return(a)};

midnode.prototype.searchtarget_word=function(){var a=-1;if((this.searchin_word-this.searchinpast)>0){if(((this.searchin_word-this.searchinpast)/(this.richness_val))>0.7){this.targeted=true;if(this.child1){this.child1.targeted=false;this.child2.targeted=false}if((this.child1)&&(((this.child1).searchin_word>0)||((this.child2).searchin_word>0))){if((((this.child1).searchin_word)-((this.child1).searchinpast))<=0){var c=(this.child2).searchtarget_word();a=c}else{if((((this.child2).searchin_word)-((this.child2).searchinpast))<=0){var c=(this.child1).searchtarget_word();a=c}else{a=this.searchin_word}}}else{a=this.searchin_word}}else{if(this.child1){var d=this.child1.searchtarget_word();var b=this.child2.searchtarget_word()}if(d>b){this.child1.targeted=true;this.child2.targeted=false;a=d}else{this.child2.targeted=true;this.child1.targeted=false;a=b}}}return(a)};

midnode.prototype.searchtarget_full=function(){var a=-1;if((this.searchin_full-this.searchinpast)>0){if(((this.searchin_full-this.searchinpast)/(this.richness_val))>0.7){this.targeted=true;if(this.child1){this.child1.targeted=false;this.child2.targeted=false}if((this.child1)&&(((this.child1).searchin_full>0)||((this.child2).searchin_full>0))){if((((this.child1).searchin_full)-((this.child1).searchinpast))<=0){var c=(this.child2).searchtarget_full();a=c}else{if((((this.child2).searchin_full)-((this.child2).searchinpast))<=0){var c=(this.child1).searchtarget_full();a=c}else{a=this.searchin_full}}}else{a=this.searchin_full}}else{if(this.child1){var d=this.child1.searchtarget_full();var b=this.child2.searchtarget_full()}if(d>b){this.child1.targeted=true;this.child2.targeted=false;a=d}else{this.child2.targeted=true;this.child1.targeted=false;a=b}}}return(a)};

midnode.prototype.searchtargetmark=function(){var a=-1;if(this.targeted){a=this.searchin;if(this.child1){if(this.child1.targeted){a=this.child1.searchtargetmark()}else{if(this.child2.targeted){a=this.child2.searchtargetmark()}}}this.searchinpast+=a}return(a)};

midnode.prototype.clearsearch=function(){this.searchin=0;this.searchin_full=0;this.searchin_word=0;this.targeted=false;this.searchinpast=0;this.flysofarA=false;this.flysofarB=false;if(this.child1){(this.child1).clearsearch();(this.child2).clearsearch()}};

midnode.prototype.clearroute=function(){this.onroute=false;if(this.child1){(this.child1).clearroute();(this.child2).clearroute()}};

midnode.prototype.semiclearsearch=function(){this.targeted=false;this.flysofarA=false;this.flysofarB=false;if(this.child1){(this.child1).semiclearsearch();(this.child2).semiclearsearch()}};

midnode.prototype.setxyr=function(n,m,a,l,b,k,s,e,f){var d;var o;var q;var h;if(this.child1){if(e!=2){d=n+a*this.nextx1+a*this.nextr1*this.child1.hxmax;o=n+a*this.nextx1+a*this.nextr1*this.child1.hxmin;q=m+a*this.nexty1+a*this.nextr1*this.child1.hymax;h=m+a*this.nexty1+a*this.nextr1*this.child1.hymin;if(e!=1){if(d<(n+a*this.nextx2+a*this.nextr2*this.child2.hxmax)){d=(n+a*this.nextx2+a*this.nextr2*this.child2.hxmax)}if(o>(n+a*this.nextx2+a*this.nextr2*this.child2.hxmin)){o=(n+a*this.nextx2+a*this.nextr2*this.child2.hxmin)}if(q<(m+a*this.nexty2+a*this.nextr2*this.child2.hymax)){q=(m+a*this.nexty2+a*this.nextr2*this.child2.hymax)}if(h>(m+a*this.nexty2+a*this.nextr2*this.child2.hymin)){h=(m+a*this.nexty2+a*this.nextr2*this.child2.hymin)}}}else{d=n+a*this.nextx2+a*this.nextr2*this.child2.hxmax;o=n+a*this.nextx2+a*this.nextr2*this.child2.hxmin;q=m+a*this.nexty2+a*this.nextr2*this.child2.hymax;h=m+a*this.nexty2+a*this.nextr2*this.child2.hymin}}else{d=(n+a*(this.arcx+this.arcr));o=(n+a*(this.arcx-this.arcr));q=(m+a*(this.arcy+this.arcr));h=(m+a*(this.arcy-this.arcr))}if(d<(n+a*(this.bezsx+this.bezex)/2)){d=(n+a*(this.bezsx+this.bezex)/2)}if(o>(n+a*(this.bezsx+this.bezex)/2)){o=(n+a*(this.bezsx+this.bezex)/2)}if(q<(m+a*(this.bezsy+this.bezey)/2)){q=(m+a*(this.bezsy+this.bezey)/2)}if(h>(m+a*(this.bezsy+this.bezey)/2)){h=(m+a*(this.bezsy+this.bezey)/2)}var g=((s-k)/(q-h));var c=((b-l)/(d-o));var p;if(g>c){p=c}else{p=g}xp+=(((b+l)/2)-((d+o)/2));yp+=(((s+k)/2)-((q+h)/2));ws=ws*p;xp=widthres/2+(xp-widthres/2)*p;yp=heightres/2+(yp-heightres/2)*p};

midnode.prototype.setxyr4r=function(h,b,g,p){ws=1;xp=widthres/2;yp=heightres;var l=xp;var k=yp;var a=220*ws;var d;var m;var o;var f;d=(l+a*(this.arcx+this.arcr));m=(l+a*(this.arcx-this.arcr));o=(k+a*(this.arcy+this.arcr));f=(k+a*(this.arcy-this.arcr));var e=((p-g)/(o-f));var c=((b-h)/(d-m));var n;if(e>c){n=c}else{n=e}xp+=(((b+h)/2)-((d+m)/2));yp+=(((p+g)/2)-((o+f)/2));ws=ws*n;xp=widthres/2+(xp-widthres/2)*n;yp=heightres/2+(yp-heightres/2)*n};

midnode.prototype.setxyr3r=function(h,b,g,p){ws=1;xp=widthres/2;yp=heightres;var l=xp;var k=yp;var a=220*ws;var d;var m;var o;var f;if(this.child1){d=l+a*this.nextx1+a*this.nextr1*this.child1.hxmax;m=l+a*this.nextx1+a*this.nextr1*this.child1.hxmin;o=k+a*this.nexty1+a*this.nextr1*this.child1.hymax;f=k+a*this.nexty1+a*this.nextr1*this.child1.hymin;if(d<(l+a*this.nextx2+a*this.nextr2*this.child2.hxmax)){d=(l+a*this.nextx2+a*this.nextr2*this.child2.hxmax)}if(m>(l+a*this.nextx2+a*this.nextr2*this.child2.hxmin)){m=(l+a*this.nextx2+a*this.nextr2*this.child2.hxmin)}if(o<(k+a*this.nexty2+a*this.nextr2*this.child2.hymax)){o=(k+a*this.nexty2+a*this.nextr2*this.child2.hymax)}if(f>(k+a*this.nexty2+a*this.nextr2*this.child2.hymin)){f=(k+a*this.nexty2+a*this.nextr2*this.child2.hymin)}}else{d=(l+a*(this.arcx+this.arcr));m=(l+a*(this.arcx-this.arcr));o=(k+a*(this.arcy+this.arcr));f=(k+a*(this.arcy-this.arcr))}var e=((p-g)/(o-f));var c=((b-h)/(d-m));var n;if(e>c){n=c}else{n=e}xp+=(((b+h)/2)-((d+m)/2));yp+=(((p+g)/2)-((o+f)/2));ws=ws*n;xp=(b+h)/2+(xp-(b+h)/2)*n;yp=(p+g)/2+(yp-(p+g)/2)*n};

midnode.prototype.setxyr2=function(h,g,n,c,d,p,s,q,w,l){var k;var f;var o;var m;if(q!=3){k=(h+n*(this.fxmax));f=(h+n*(this.fxmin));o=(g+n*(this.fymax));m=(g+n*(this.fymin))}else{if(this.child1){k=h+n*this.nextx1+n*this.nextr1*this.child1.hxmax;f=h+n*this.nextx1+n*this.nextr1*this.child1.hxmin;o=g+n*this.nexty1+n*this.nextr1*this.child1.hymax;m=g+n*this.nexty1+n*this.nextr1*this.child1.hymin;if(k<(h+n*this.nextx2+n*this.nextr2*this.child2.hxmax)){k=(h+n*this.nextx2+n*this.nextr2*this.child2.hxmax)}if(f>(h+n*this.nextx2+n*this.nextr2*this.child2.hxmin)){f=(h+n*this.nextx2+n*this.nextr2*this.child2.hxmin)}if(o<(g+n*this.nexty2+n*this.nextr2*this.child2.hymax)){o=(g+n*this.nexty2+n*this.nextr2*this.child2.hymax)}if(m>(g+n*this.nexty2+n*this.nextr2*this.child2.hymin)){m=(g+n*this.nexty2+n*this.nextr2*this.child2.hymin)}}else{k=(h+n*(this.arcx+this.arcr));f=(h+n*(this.arcx-this.arcr));o=(g+n*(this.arcy+this.arcr));m=(g+n*(this.arcy-this.arcr))}if(k<(h+n*(this.bezsx+this.bezex)/2)){k=(h+n*(this.bezsx+this.bezex)/2)}if(f>(h+n*(this.bezsx+this.bezex)/2)){f=(h+n*(this.bezsx+this.bezex)/2)}if(o<(g+n*(this.bezsy+this.bezey)/2)){o=(g+n*(this.bezsy+this.bezey)/2)}if(m>(g+n*(this.bezsy+this.bezey)/2)){m=(g+n*(this.bezsy+this.bezey)/2)}}var a=((s-p)/(o-m));var b=((d-c)/(k-f));var u;if(a>b){u=b}else{u=a}u=Math.pow(u,(1/w));var e;var v;if(Math.abs(u-1)<0.000001){e=(((d+c)/2)-((k+f)/2));v=(((s+p)/2)-((o+m)/2))}else{e=(((d+c)/2)-((k+f)/2))*((1-(1/u))/(1-(Math.pow((1/u),w))));v=(((s+p)/2)-((o+m)/2))*((1-(1/u))/(1-(Math.pow((1/u),w))))}xp+=e;yp+=v;ws=ws*u;xp=widthres/2+(xp-widthres/2)*u;yp=heightres/2+(yp-heightres/2)*u};

midnode.prototype.move=function(d,b,c,a){if(this.targeted){this.graphref=true;if(this.child1){if(this.child1.targeted){this.child1.move(d,b,c,a)}else{if(this.child2.targeted){this.child2.move(d,b,c,a)}else{this.setxyr3r(40,widthres-40,40,heightres-40);this.setxyr3r(40,widthres-40,40,heightres-40)}}}else{this.setxyr3r(40,widthres-40,40,heightres-40);this.setxyr3r(40,widthres-40,40,heightres-40)}}};

midnode.prototype.move4=function(d,b,c,a){if(this.targeted){this.graphref=true;if(this.child1){if(this.child1.targeted){this.child1.move4(d,b,c,a)}else{if(this.child2.targeted){this.child2.move4(d,b,c,a)}else{this.setxyr4r(40,widthres-40,65,heightres-40);this.setxyr4r(40,widthres-40,65,heightres-40)}}}else{this.setxyr4r(40,widthres-40,65,heightres-40);this.setxyr4r(40,widthres-40,65,heightres-40)}}};

midnode.prototype.move3=function(d,b,c,a){if(this.onroute){if(this.child1){if(this.child1.onroute){this.child1.move3(d,b,c,a)}else{if(this.child2.onroute){this.child2.move3(d,b,c,a)}else{this.setxyr3r(40,widthres-40,40,heightres-40);this.setxyr3r(40,widthres-40,40,heightres-40)}}}else{this.setxyr3r(40,widthres-40,40,heightres-40);this.setxyr3r(40,widthres-40,40,heightres-40)}}};

midnode.prototype.move2=function(){if(this.dvar){this.onroute=true;if((!(this.gvar))&&(this.child1)){if(!((this.child1.dvar)&&(this.child2.dvar))){if(this.child1.dvar){this.child1.move2()}else{if(this.child2.dvar){this.child2.move2()}}}}}};

midnode.prototype.clearonroute=function(){this.onroute=false;if(this.child1){(this.child1).clearonroute();
(this.child2).clearonroute()}};

midnode.prototype.flyFB=function(f,d,e,c){var b=6;if(screensaver_on){b=screen_saver.flightspeed}var a=this.xvar;var h=this.yvar;var g=this.rvar;if(this.targeted){if(this.flysofarB){if(this.child1){if(this.child1.targeted){this.child1.flyFB(f,d,e,c)}else{if(this.child2.targeted){this.child2.flyFB(f,d,e,c)}else{if(this.flysofarB){if(flying){clearTimeout(t);fulltree.searchtargetmark();flying=false;flying_2=false}}else{this.setxyr2(a,h,g,f,d,e,c,3,countdownB,2);if(countdownB<=1){this.flysofarB=true;countdownB=b}else{countdownB--}}}}}else{if(this.flysofarB){if(flying){clearTimeout(t);fulltree.searchtargetmark();flying=false;flying_2=false}}else{this.setxyr2(a,h,g,f,d,e,c,3,countdownB,2);if(countdownB<=1){this.flysofarB=true;countdownB=b}else{countdownB--}}}}else{if(this.child1){if(this.child1.targeted){this.setxyr2(a,h,g,f,d,e,c,1,countdownB,2);if(countdownB<=1){this.flysofarB=true;countdownB=b}else{countdownB--}}else{if(this.child2.targeted){this.setxyr2(a,h,g,f,d,e,c,2,countdownB,2);if(countdownB<=1){this.flysofarB=true;countdownB=b}else{countdownB--}}else{if(this.flysofarB){if(flying){clearTimeout(t);fulltree.searchtargetmark();flying=false;flying_2=false}}else{this.setxyr2(a,h,g,f,d,e,c,3,countdownB,2);if(countdownB<=1){this.flysofarB=true;countdownB=b}else{countdownB--}}}}}else{if(this.flysofarB){if(flying){clearTimeout(t);fulltree.searchtargetmark();flying=false;flying_2=false}}else{this.setxyr2(a,h,g,f,d,e,c,3,countdownB,2);if(countdownB<=1){this.flysofarB=true;countdownB=b}else{countdownB--}}}}}};

midnode.prototype.prepfly=function(a,c,b){if(this.targeted){this.fxmax=this.gxmax;this.fxmin=this.gxmin;this.fymax=this.gymax;this.fymin=this.gymin;if(this.child1){if(this.child1.targeted){this.child1.prepfly(a+b*this.nextx1,c+b*this.nexty1,b*this.nextr1);if(this.fxmax<(this.nextx1+this.nextr1*this.child1.fxmax)){this.fxmax=(this.nextx1+this.nextr1*this.child1.fxmax)}if(this.fxmin>(this.nextx1+this.nextr1*this.child1.fxmin)){this.fxmin=(this.nextx1+this.nextr1*this.child1.fxmin)}if(this.fymax<(this.nexty1+this.nextr1*this.child1.fymax)){this.fymax=(this.nexty1+this.nextr1*this.child1.fymax)}if(this.fymin>(this.nexty1+this.nextr1*this.child1.fymin)){this.fymin=(this.nexty1+this.nextr1*this.child1.fymin)}}else{if(this.child2.targeted){this.child2.prepfly(a+b*this.nextx2,c+b*this.nexty2,b*this.nextr2);if(this.fxmax<(this.nextx2+this.nextr2*this.child2.fxmax)){this.fxmax=(this.nextx2+this.nextr2*this.child2.fxmax)}if(this.fxmin>(this.nextx2+this.nextr2*this.child2.fxmin)){this.fxmin=(this.nextx2+this.nextr2*this.child2.fxmin)}if(this.fymax<(this.nexty2+this.nextr2*this.child2.fymax)){this.fymax=(this.nexty2+this.nextr2*this.child2.fymax)}if(this.fymin>(this.nexty2+this.nextr2*this.child2.fymin)){this.fymin=(this.nexty2+this.nextr2*this.child2.fymin)}}else{this.fxmax=this.hxmax;this.fxmin=this.hxmin;this.fymax=this.hymax;this.fymin=this.hymin}}}else{this.fxmax=this.hxmax;this.fxmin=this.hxmin;this.fymax=this.hymax;this.fymin=this.hymin}}};

var searchtext=null;
function marksearch(){clear_screensaver();if((!flying)&&(((searchstring)&&(searchstring!=""))||((search_sounds)||(search_images)))){performsearch2(false);highlight_search=true;if(fulltree.searchin==1){searchtext="1 hit"}else{if(fulltree.searchin<=0){searchtext="no hits"}else{searchtext=((fulltree.searchin).toString()+" hits")}}if(growing){growend();growplay()}else{if(growingpause){growend();growplay();growpause()}else{setTimeout("draw2()",30)}}}}
function cyclesearch(){performleap()}
function unmarksearch(){clear_screensaver();if(highlight_search){highlight_search=false}else{highlight_search=true}draw2()}
function performclear(){highlight_search=false;searchinparts=[];draw2()}
function ranked_search(){performsearch2(false);if(fulltree.searchtarget_full()==-1){if(fulltree.searchtarget_word()==-1){if(fulltree.searchtarget()==-1){searchinparts=[];ranked_search()}}}}
midnode.prototype.drawreg_target=function(a,c,b){if(this.child1){if(this.child1.graphref){this.child1.drawreg_target(a,c,b);this.rvar=this.child1.rvar/this.nextr1;this.xvar=this.child1.xvar-this.rvar*this.nextx1;this.yvar=this.child1.yvar-this.rvar*this.nexty1;if(this.targeted){this.child2.drawreg2_target(this.xvar+((this.rvar)*(this.nextx2)),this.yvar+(this.rvar)*(this.nexty2),this.rvar*this.nextr2)}}else{if(this.child2.graphref){this.child2.drawreg_target(a,c,b);this.rvar=this.child2.rvar/this.nextr2;this.xvar=this.child2.xvar-this.rvar*this.nextx2;this.yvar=this.child2.yvar-this.rvar*this.nexty2;if(this.targeted){this.child1.drawreg2_target(this.xvar+((this.rvar)*(this.nextx1)),this.yvar+(this.rvar)*(this.nexty1),this.rvar*this.nextr1)}}else{this.drawreg2_target(a,c,b)}}}else{this.drawreg2_target(a,c,b)}};

midnode.prototype.drawreg2_target=function(a,c,b){this.xvar=a;this.yvar=c;this.rvar=b;if(this.targeted){if(this.child1){this.child1.drawreg2_target(a+((b)*(this.nextx1)),c+(b)*(this.nexty1),b*this.nextr1);this.child2.drawreg2_target(a+((b)*(this.nextx2)),c+(b)*(this.nexty2),b*this.nextr2)
}}};

midnode.prototype.cleartarget=function(){this.targeted=false;if(this.child1){(this.child1).cleartarget();(this.child2).cleartarget()}};

midnode.prototype.target_by_code=function(b,a){if(b>0){if(this.child1){this.targeted=this.child1.target_by_code(b,a);if(this.child2.target_by_code(b,a)){this.targeted=true}}else{if(this.metacode==a){this.targeted=true}else{this.targeted=false}}}else{if(this.child1){if(this.metacode==a){this.targeted=true}else{this.targeted=this.child1.target_by_code(b,a);if(this.child2.target_by_code(b,a)){this.targeted=true}}}else{this.targeted=false}}return this.targeted};

var global_anim_speed;
function perform_flight_animation(b,a){global_anim_speed=100/a;if(b>0){to_leaf=-1;to_index=b}else{to_leaf=1;to_index=-b}fulltree.cleartarget();fulltree.target_by_code(to_leaf,to_index);return perform_flight_animation2()}
function perform_leap_animation(a){clearTimeout(t);flying=false;flying_2=false;if(a>0){to_leaf=-1;to_index=a}else{to_leaf=1;to_index=-a}fulltree.cleartarget();fulltree.target_by_code(to_leaf,to_index);fulltree.deanchor();fulltree.move(40,widthres-40,65,heightres-40);setTimeout("draw2()",1)}
function perform_flight_animation2(){more_flying_needed=false;fulltree.drawreg_target(xp,yp,220*ws);pre_xp=xp;pre_yp=yp;pre_ws=ws;fulltree.get_xyr_target(xp,yp,220*ws);intro_step_num=0;intro_sec_step_num=0;if(((r_mult>0.9999)&&(r_mult<1.00001))&&(x_add*x_add<1)&&(y_add*y_add<1)){return false}else{length_intro=Math.abs(Math.log(r_mult))*global_anim_speed;num_intro_steps=Math.max(Math.floor(length_intro),5);flying=true;flying_2=true;performflyB2();return true}}
function performflyB2_waiting(){clearTimeout(ttt);if(performflyB2_var==1){if(more_flying_needed){ttt=setTimeout("perform_flight_animation2()",1)}else{ttt=setTimeout("performflyB2()",1)}}else{ttt=setTimeout("performflyB2_waiting()",1)}}
function performflyB2(){performflyB2_var=-1;if((intro_step_num<num_intro_steps)&&(introlock||flying)){intro_step_num++;intro_sec_step_num++;clearTimeout(t);t=setTimeout("performflyB2_waiting()",60);if(r_mult>=1){auto_pan_zoom(intro_sec_step_num/num_intro_steps,intro_sec_step_num/num_intro_steps)}else{auto_pan_zoom_out(intro_sec_step_num/num_intro_steps,intro_sec_step_num/num_intro_steps)}if(!more_flying_needed){draw2()}performflyB2_var=1}else{if(screensaver_on){flying=false;flying_2=false;if(screen_saver.animation_wait>=0){tout_aw=setTimeout("screen_saver_postaction()",screen_saver.animation_wait*100)}}else{if(flying){if(more_flying_needed){clearTimeout(ttt);ttt=setTimeout("perform_flight_animation2()",1)}else{fulltree.searchtargetmark();flying=false;flying_2=false}}}}}
function performfly(){if(!flying){if(screensaver_on){nowplaying=null;justplayednew=false;if(thisSound.duration){thisSound.currentTime=thisSound.duration}}if(viewtype==2){fulltree.deanchor();fulltree.graphref=true;fulltree.setxyr(xp,yp,220*ws,20,widthres-2,65,heightres,0,1);fulltree.setxyr(xp,yp,220*ws,20,widthres-2,65,heightres,0,1);wsinit=ws;draw2();fulltree.semiclearsearch();flying=true;if(screensaver_on){temprand=Math.random();fulltree.clearsearch();if(temprand<((screen_saver.pic)/(screen_saver.sound+screen_saver.pic))){fulltree.randomsearch_()}else{fulltree.randomsearch_s()}}else{ranked_search()}fulltree.targeted=true;countdownB=18;fulltree.flysofarB=true;if(fulltree.child1){if(fulltree.child1.targeted){if(((fulltree.child1).child1)&&((fulltree.child1).child1.targeted||(fulltree.child1).child2.targeted)){fulltree.child1.flysofarB=true}}if(fulltree.child2.targeted){if(((fulltree.child2).child1)&&((fulltree.child2).child1.targeted||(fulltree.child2).child2.targeted)){fulltree.child2.flysofarB=true}}}fulltree.prepfly(xp,yp,220*ws,5);performfly2()}else{fulltree.clear_xyr_var();fulltree.deanchor();fulltree.graphref=true;fulltree.setxyr(xp,yp,220*ws,20,widthres-2,65,heightres,0,1);fulltree.setxyr(xp,yp,220*ws,20,widthres-2,65,heightres,0,1);wsinit=ws;draw2();fulltree.semiclearsearch();flying=true;if(screensaver_on){temprand=Math.random();fulltree.clearsearch();if(temprand<((screen_saver.pic)/(screen_saver.sound+screen_saver.pic))){fulltree.randomsearch_()}else{fulltree.randomsearch_s()}}else{ranked_search()}fulltree.targeted=true;fulltree.drawreg(xp,yp,220*ws);fulltree.get_xyr_target(xp,yp,220*ws);pre_xp=xp;pre_yp=yp;pre_ws=ws;intro_step_num=0;intro_sec_step_num=0;length_intro=Math.abs(Math.log(r_mult))*length_intro_in;num_intro_steps=length_intro;draw2();t=setTimeout("performflyB2()",1)}}}

var performflyB2_var=-1;
var performfly2_var=-1;
var ttt;
function performfly2(){performfly2_var=-1;t=setTimeout("performfly2_waiting()",50);fulltree.drawreg(xp,yp,220*ws);fulltree.flyFB(40,widthres-40,65,heightres-40);draw2();if(flying){performfly2_var=1}else{performfly2_var=-1;clearTimeout(ttt);clearTimeout(t);if(screensaver_on){flying=false;flying_2=false;if(screen_saver.animation_wait>=0){tout_aw=setTimeout("screen_saver_postaction()",screen_saver.animation_wait*100)}}}}
function performfly2_waiting(){clearTimeout(ttt);if(performfly2_var==1){ttt=setTimeout("performfly2()",1)}else{ttt=setTimeout("performfly2_waiting()",1)}}
function continue_flyB(){clearTimeout(t);intro_sec_step_num=0;num_intro_steps=length_intro-intro_step_num;fulltree.get_xyr_target(xp,yp,220*ws);pre_xp=xp;pre_yp=yp;pre_ws=ws;t=setTimeout("performflyB2()",1)}
midnode.prototype.get_xyr_target=function(c,m,f){var n,l,a;if(this.rvar){n=this.xvar;l=this.yvar;a=this.rvar}else{n=c;l=m;a=f}if(this.targeted){var e;var o;var p;var h;if(this.child1){e=n+a*this.nextx1+a*this.nextr1*this.child1.hxmax;o=n+a*this.nextx1+a*this.nextr1*this.child1.hxmin;p=l+a*this.nexty1+a*this.nextr1*this.child1.hymax;h=l+a*this.nexty1+a*this.nextr1*this.child1.hymin;if(e<(n+a*this.nextx2+a*this.nextr2*this.child2.hxmax)){e=(n+a*this.nextx2+a*this.nextr2*this.child2.hxmax)}if(o>(n+a*this.nextx2+a*this.nextr2*this.child2.hxmin)){o=(n+a*this.nextx2+a*this.nextr2*this.child2.hxmin)}if(p<(l+a*this.nexty2+a*this.nextr2*this.child2.hymax)){p=(l+a*this.nexty2+a*this.nextr2*this.child2.hymax)}if(h>(l+a*this.nexty2+a*this.nextr2*this.child2.hymin)){h=(l+a*this.nexty2+a*this.nextr2*this.child2.hymin)}}else{e=(n+a*(this.arcx+this.arcr*1.305));o=(n+a*(this.arcx-this.arcr*1.305));p=(l+a*(this.arcy+this.arcr*1.305));h=(l+a*(this.arcy-this.arcr*1.305))}var b=e;var k=o;var g=p;var d=h;if(((widthres)/(heightres))>((b-k)/(g-d))){r_mult=(heightres*targetScreenProp)/(g-d)}else{r_mult=(widthres*targetScreenProp)/(b-k)}x_add=(b+k-widthres)/2;y_add=(g+d-heightres)/2;if((r_mult<10000000)||(r_mult>1e-8)){if(this.child1){if(this.child1.targeted){this.child1.get_xyr_target(n+a*this.nextx1,l+a*this.nexty1,a*this.nextr1)}else{if(this.child2.targeted){this.child2.get_xyr_target(n+a*this.nextx2,l+a*this.nexty2,a*this.nextr2)}}}}else{more_flying_needed=true}}};

auto_pan_zoom=function(a,b){var c=y_add+heightres/2;var d=x_add+widthres/2;ws=pre_ws*(Math.pow(r_mult,b));xp=d+(pre_xp-d)*(Math.pow(r_mult,b))-x_add*a;yp=c+(pre_yp-c)*(Math.pow(r_mult,b))-y_add*a};

zoomoutfactor=function(a){ws=ws*a;xp=widthres/2+(xp-widthres/2)*a;yp=heightres/2+(yp-heightres/2)*a;draw2()};

auto_pan_zoom_out=function(k,d){var e=widthres/2+(pre_xp-widthres/2-x_add)*r_mult;var l=heightres/2+(pre_yp-heightres/2-y_add)*r_mult;var a=pre_ws*r_mult;var b=1-k;var h=1-d;var c=(-y_add)*r_mult;var n=(-x_add)*r_mult;var m=1/r_mult;var f=c+heightres/2;var g=n+widthres/2;ws=a*(Math.pow(m,h));xp=g+(e-g)*(Math.pow(m,h))-n*b;yp=f+(l-f)*(Math.pow(m,h))-c*b};

midnode.prototype.clear_xyr_var=function(){if(this.child1){this.child1.clear_xyr_var();this.child2.clear_xyr_var()}this.xvar=null;this.yvar=null;this.rvar=null};

var x_add;
var y_add;
var r_mult;
var pre_xp;
var pre_yp;
var pre_ws;
var more_flying_needed;
var length_intro;
var num_intro_steps;
var intro_step_num;
var intro_sec_step_num;

function performleap(){clearTimeout(t);flying=false;flying_2=false;if(screensaver_on){nowplaying=null;justplayednew=false;if(thisSound.duration){thisSound.currentTime=thisSound.duration}temprand=Math.random();fulltree.clearsearch();if(temprand<((screen_saver.zoomin__)/(screen_saver.zoomin__+screen_saver.zoomin_random))){fulltree.randomsearch_()}else{fulltree.randomsearch()}}else{ranked_search();fulltree.targeted=true;fulltree.searchtargetmark()}fulltree.deanchor();if(screensaver_on){temprand3=Math.random();if(temprand3<0.65){fulltree.move4(20,widthres-20,65,heightres-20)}else{fulltree.move(20,widthres-20,65,heightres-20)}}else{fulltree.move(40,widthres-40,65,heightres-40)}draw2();if(screensaver_on){if(slideshow_progress==-1){draw2();if(screen_saver.animation_wait>=0){tout_aw=setTimeout("zoomout_animation()",screen_saver.animation_wait*100)}}else{if(slideshow_progress>=1){slideshow_progress=slideshow_progress-1;if(screen_saver.animation_wait>=0){tout_aw=setTimeout("performleap()",screen_saver.animation_wait*100)}}else{draw2();if(screen_saver.animation_wait>=0){tout_aw=setTimeout("screen_saver_preaction()",screen_saver.animation_wait*100)}}}}setTimeout("draw2()",1)}
midnode.prototype.oldest=function(){var c=0;if(this.dvar){if(this.gvar){if(this.lengthbr){if(this.lengthbr>c){c=this.lengthbr}}}if(this.child1){var b=this.child1.oldest();var a=this.child2.oldest();if(b>c){c=b}if(a>c){c=a}}}return c};

var original_timelim;
function growstart(){timelim=fulltree.oldest();original_timelim=timelim;clearTimeout(t2);growingpause=true;growingdir=true;growing=false;Resize()}
function growrev(){original_timelim=fulltree.oldest();if(timelim>=original_timelim){timelim=-0.001}clearTimeout(t2);growingpause=false;growingdir=false;growing=true;Resize();timeinc=(original_timelim)/(growthtimetot*10);grow3()}
function growpause(){clearTimeout(t2);growingpause=true;growing=false;Resize()}
function growplay(){if(timelim<=0){timelim=fulltree.oldest();original_timelim=timelim}clearTimeout(t2);growingpause=false;growingdir=true;growing=true;Resize();timeinc=fulltree.oldest()/(growthtimetot*10);if(timeinc<=0){timeinc=1}grow2()}
function growend(){clearTimeout(t2);timelim=-3;clearTimeout(t2);growingpause=false;growing=false;Resize()}
function grow2(){if(timelim>=0){timelim-=timeinc;draw2();
t2=setTimeout("grow2()",100)}else{clearTimeout(t2);draw2();growing=false;growingpause=false;if(screensaver_on){t2=setTimeout("screen_saver_postaction()",3000)}else{t2=setTimeout("Resizepostgrow()",3000)}}}
function Resizepostgrow(){Resize()}
function grow3(){if(timelim<=original_timelim){timelim+=timeinc;draw2();t2=setTimeout("grow3()",50)}else{clearTimeout(t2);draw2();timelim=-3;t2=setTimeout("draw2()",50);growing=false;growingpause=false}}
var num_int_pics=8;

function gpmapper(a){if(a>2500){return("Pre Siderian")}else{if(a>2300){return("Siderian")}else{if(a>2050){return("Rhyacian")}else{if(a>1800){return("Orosirian")}else{if(a>1600){return("Statherian")}else{if(a>1400){return("Calymmian")}else{if(a>1200){return("Ectasian")}else{if(a>1000){return("Stenian")}else{if(a>850){return("Tonian")}else{if(a>635){return("Cryogenian")}else{if(a>541){return("Ediacaran")}else{if(a>485.4){return("Cambrian")}else{if(a>443.4){return("Ordovician")}else{if(a>419.2){return("Silurian")}else{if(a>359.2){return("Devonian")}else{if(a>298.9){return("Carboniferous")}else{if(a>252.2){return("Permian")}else{if(a>203.6){return("Triassic")}else{if(a>150.8){return("Jurassic")}else{if(a>70.6){return("Cretaceous")}else{if(a>28.4){return("Paleogene")}else{if(a>3.6){return("Neogene")}else{return("Quaternary")}}}}}}}}}}}}}}}}}}}}}}}
midnode.prototype.fakeleaflogic=function(a,d,b,c){this.leafpic_drawn=false;circularOutlinedLeaf(context,a,d,b,b*0.12,this.leafcolor1(),this.leafcolor2())};

midnode.prototype.growthleaflogic=function(a,d,b,c){if(leaftype==1){add_MR(a,d,b);circularOutlinedLeaf(context,a,d,b,b*0.12,this.leafcolor1(),this.leafcolor2())}else{add_MR(a,d,b*0.9);randomNaturalLeaf(context,a,d,b*0.9,c,this.leafcolor1(),this.leafcolor2())}};

midnode.prototype.tipleaflogicBase=function(a,g,d,f){if(!((((a-d*1.305)>widthres)||((a+d*1.305)<0))||(((g-d*1.305)>heightres)||((g+d*1.305)<0)))){if(this.richness_val>1){var e={insideColor:this.leafcolor1(),outlineColor:this.leafcolor2(),BGColor:backgroundcolor,sponsorColor:"rgb(110,110,110)",textColor:this.leafcolor3(),highlightColor:"rgba(0,0,0,0.6)",imageLineColor:"rgb(110,110,110)",waterMark:"rgba(255,255,255,0.4)"};add_MR(a,g,d);ghostLeafBase(context,a,g,d,f,e)}else{var b=d;if(leaftype!=1){b=d*0.9}var c=this.leafcolor3();add_MR(a,g,b);var e={insideColor:this.leafcolor1(),outlineColor:this.leafcolor2(),BGColor:backgroundcolor,sponsorColor:c,textColor:this.leafcolor3(),highlightColor:"rgb(255,255,255)",imageLineColor:"rgb(110,110,110)",waterMark:"rgba(255,255,255,0.4)"};fullLeafBase(context,a,g,b,f,leaftype,e)}}};

midnode.prototype.tipleaflogic=function(k,f,a,c){this.leafpic_drawn=false;if(!((((k-a)>widthres)||((k+a)<0))||(((f-a)>heightres)||((f+a)<0)))){
	if(a>16) {if(this.pic_qual){load_image_s(this.metacode);if(!((!pic_loading_s[pic_vect_s[this.metacode]])&&(pic_cache_s[pic_vect_s[this.metacode]]))){pics_unloaded=true}}}context.strokeStyle=this.leafcolor2();context.fillStyle=this.leafcolor1();var p=null;var m=null;if(this.pic_file){if((!pic_loading_s[pic_vect_s[this.metacode]])&&(pic_cache_s[pic_vect_s[this.metacode]])){p=pic_cache_s[pic_vect_s[this.metacode]]}if((mc_key_l[data_pic_col_credit])&&(metadata.leaf_meta[this.metacode][mc_key_l[data_pic_col_credit]])){m=metadata.leaf_meta[this.metacode][mc_key_l[data_pic_col_credit]]}}
	var b=null;
	if(this.name1){if(this.name2){b=this.name2+" "+this.name1}else{b=this.name1}}
	else{if(this.name2){b=this.name2}else{b=null}}
	if(this.richness_val>1){var n={insideColor:this.leafcolor1(),outlineColor:this.leafcolor2(),BGColor:backgroundcolor,sponsorColor:"rgb(110,110,110)",textColor:this.leafcolor3(),highlightColor:"rgba(0,0,0,0.6)",imageLineColor:"rgb(110,110,110)",waterMark:"rgba(255,255,255,0.4)"};add_MR(k,f,a);var e=ghostLeaf(context,k,f,a,c,global_auto_button,this.cname,b,this.specnumfull(),m,p,this.pic_qual,n);if((a>20)&&(this.pic_qual)){this.leafpic_drawn=true}if(e=="z"){tap2zoom=-this.metacode}if(e=="c"){global_button_action="http://eol.org/data_objects/"+(metadata.leaf_meta[this.metacode][mc_key_l.picID]).toString();is_clicked=true}if((e=="s")&&(metadata.leaf_meta[this.metacode][mc_key_l.OTTid])){global_button_action="https://en.wikipedia.org/wiki/"+metadata.leaf_meta[this.metacode][mc_key_l.scientificName];is_clicked=true}}
	else{var q="WIKIPEDIA";var h="";var o=0;var d=a;var g=this.leafcolor3();if(leaftype!=1){d=a*0.9;if(o){g=this.leafcolor4()}else{g=this.leafcolor1()}}add_MR(k,f,d);var e;var n={insideColor:this.leafcolor1(),outlineColor:this.leafcolor2(),BGColor:backgroundcolor,sponsorColor:g,textColor:this.leafcolor3(),highlightColor:"rgb(255,255,255)",imageLineColor:"rgb(110,110,110)",waterMark:"rgba(255,255,255,0.4)"};if(o){e=fullLeaf(context,k,f,d,c,leaftype,o,global_auto_button,q,h,this.cname,b,this.leaf_txtline1(),this.leaf_txtline2(),m,p,this.pic_qual,n)}else{n.sponsorColor=this.leafcolor1();e=fullLeaf(context,k,f,d,c,leaftype,o,global_auto_button,q,h,this.cname,b,this.leaf_txtline1(),this.leaf_txtline2(),m,p,this.pic_qual,n)}if((a>20)&&(this.pic_qual)){this.leafpic_drawn=true}if(e=="z"){tap2zoom=-this.metacode}if(e=="c"){global_button_action="http://eol.org/data_objects/"+(metadata.leaf_meta[this.metacode][mc_key_l.picID]).toString();is_clicked=true}if((e=="s")&&(metadata.leaf_meta[this.metacode][mc_key_l.OTTid])){global_button_action="http://en.wikipedia.org/wiki/"+metadata.leaf_meta[this.metacode][mc_key_l.scientificName];is_clicked=true}}
	}};

//midnode.prototype.datepart=function(){if(this.lengthbr>0){if(this.lengthbr>10){return(Math.round((this.lengthbr)*10)/10).toString()+" Ma"}else{if(this.lengthbr>1){return(Math.round((this.lengthbr)*100)/100).toString()+" Ma"}else{return(Math.round((this.lengthbr)*10000)/10).toString()+" Ka"}}}else{return("Date unknown")}};

//midnode.prototype.datemed=function(){if(this.lengthbr>10){return(Math.round((this.lengthbr)*10)/10).toString()+" Million years ago"}else{if(this.lengthbr>1){return(Math.round((this.lengthbr)*100)/100).toString()+" Million years ago"}else{return(Math.round((this.lengthbr)*10000)/10).toString()+" Thousand years ago"}}};

//midnode.prototype.datefull=function(){if(this.lengthbr>10){return(Math.round((this.lengthbr)*10)/10).toString()+" Million years ago ("+gpmapper(this.lengthbr)+")"}else{if(this.lengthbr>1){return(Math.round((this.lengthbr)*100)/100).toString()+" Million years ago ("+gpmapper(this.lengthbr)+")"}else{return(Math.round((this.lengthbr)*10000)/10).toString()+" Thousand years ago ("+gpmapper(this.lengthbr)+")"}}};

midnode.prototype.iprimaryname=function(){if(commonlabels){if(this.cname){return(this.cname)}else{if(this.child1){return(this.name1)}else{if((this.name1)&&(this.name2)){return(this.name2+" "+this.name1)}else{return null}}}}else{if(this.child1){if(this.name1){return(this.name1)}else{if(this.cname){return(this.cname)}else{return null}}}else{if((this.name1)&&(this.name2)){return(this.name2+" "+this.name1)}else{if(this.cname){return(this.cname)}else{return null}}}}};

midnode.prototype.isecondaryname=function(){if((this.name1)&&(this.cname)){if((this.name1)!=(this.cname)){if(commonlabels){if(this.child1){if(this.name1){return("Scientific name: "+this.name1)}else{return null}}else{if((this.name1)&&(this.name2)){return("Scientific name: "+this.name2+" "+this.name1)}else{return null}}return null}else{if(this.cname){return("Common name: "+this.cname)}else{return null}}}else{return null}}else{return null}};

midnode.prototype.draw_signs=function(){if(this.dvar){var o;var n;var a;if(this.rvar){o=this.xvar;n=this.yvar;a=this.rvar}if(this.child1){var u=false;if(((thresholdtxt*35<a*(this.hxmax-this.hxmin))&&(a<=signthresh))||(this.lengthbr<=timelim)){if((this.drawsignposts_common)&&(drawsignposts==true)){var c=0.2;var b=0.2;if(viewtype==3){c=0;b=0.3}if(viewtype==2){c=0;b=0}var m=o+a*(this.hxmax+this.hxmin)/2;var h=n+a*(this.hymax+this.hymin)/2;var f=a*(this.hxmax-this.hxmin)*0.4;var l=o+a*this.arcx;var g=n+a*this.arcy;var e=a*this.arcr*6;var s=c*l+(1-c)*m;var p=c*g+(1-c)*h;var q=b*e+(1-b)*f;var k=p-q*0.2;var d=p-q;if((this.picset_code)&&(this.picset_code.length>0)){autodraw_lsc(this.picset_code[0],s,p,q*0.6,this.metacode);if(this.cname){context.fillStyle="rgb(0,0,0)";context.strokeStyle=textoutlinecolor;context.lineCap="round";context.lineWidth=Math.min(q*0.04,5);autotext2(true,null,this.cname,s,p+q*0.6,q*1.7,Math.min(q*0.17,25),context,9)}else{if(this.name1){context.fillStyle="rgb(0,0,0)";context.strokeStyle=textoutlinecolor;context.lineCap="round";context.lineWidth=Math.min(q*0.04,5);autotext2(true,null,this.name1,s,p+q*0.6,q*1.7,Math.min(q*0.17,25),context,9)}}}else{if(this.cname){context.fillStyle="rgb(0,0,0)";context.strokeStyle=textoutlinecolor;context.lineCap="round";context.lineWidth=Math.min(q*0.08,6);autotext2(true,null,this.cname,s,p,q*2,Math.min(q*0.6,25),context,9)}else{if(this.name1){context.fillStyle="rgb(0,0,0)";context.strokeStyle=textoutlinecolor;context.lineCap="round";context.lineWidth=Math.min(q*0.08,6);autotext2(true,null,this.name1,s,p,q*2,Math.min(q*0.6,25),context,9)}}}u=true}}if(!u){if(this.lengthbr>timelim){this.child1.draw_signs();this.child2.draw_signs()}}}else{while(this.arca<0){this.arca+=2*Math.PI}if(this.lengthbr>timelim){if(this.gvar){this.tipleaflogic(o+((a)*this.arcx),n+(a)*this.arcy,a*this.arcr,this.arca)}}if(this.lengthbr<=timelim){if(this.richness_val>1){this.growthleaflogic(o+((a)*(this.arcx)),n+(a)*(this.arcy),a*leafmult*0.5*partc,this.arca)}else{this.tipleaflogic(o+((a)*this.arcx),n+(a)*this.arcy,a*this.arcr,this.arca)}}}}};

midnode.prototype.draw=function(){var a;var d;var c;if(this.dvar){if(this.rvar){a=this.xvar;d=this.yvar;c=this.rvar}if((this.child1)&&(this.lengthbr>timelim)){if((this.child1.richness_val)>=(this.child2.richness_val)){this.child1.draw();this.child2.draw()}else{this.child2.draw();this.child1.draw()}this.leafpic_drawn=((this.child1.leafpic_drawn)||(this.child2.leafpic_drawn))}var b=false;if((this.gvar)&&((polytype!=2)||(this.npolyt))){b=true;context.lineCap="round";context.lineWidth=c*(this.bezr);context.beginPath();context.moveTo(a+c*(this.bezsx),d+c*this.bezsy);context.bezierCurveTo(a+c*(this.bezc1x),d+c*(this.bezc1y),a+c*(this.bezc2x),d+c*(this.bezc2y),a+c*(this.bezex),d+c*(this.bezey));context.strokeStyle=this.branchcolor();context.stroke();if(((highlight_search)&&(this.searchin>0))||(screensaver_on&&flying&&this.targeted)){context.strokeStyle=this.highlightcolor();context.lineWidth=c*(this.bezr)/4;context.beginPath();context.moveTo(a+c*(this.bezsx),d+c*this.bezsy);context.bezierCurveTo(a+c*(this.bezc1x),d+c*(this.bezc1y),a+c*(this.bezc2x),d+c*(this.bezc2y),a+c*(this.bezex),d+c*(this.bezey));context.stroke()}}if((this.lengthbr>timelim)&&(b)){if((((this.richness_val>1)&&(this.child1))&&(c<=threshold))&&(timelim<=0)){this.fakeleaflogic(a+((c)*(this.nextx1)),d+(c)*(this.nexty1),c*leafmult*0.75*partc,this.arca)}else{if(b){if((this.richness_val>1)&&(this.child1)){this.draw_node(a,d,c)}else{while(this.arca<0){this.arca+=2*Math.PI}this.tipleaflogicBase(a+((c)*this.arcx),d+(c)*this.arcy,c*this.arcr,this.arca)}}}}}};

midnode.prototype.draw_node=function(n,m,a){
	add_MR(n+a*(this.arcx),m+a*this.arcy,a*this.arcr);
	var g=(a*partc-a*partl2)*Twidth;
	var b=(a*partc-a*partl2)*Tsize/2;
	var p=(a*partc-a*partl2)*Tsize/3;
	if((((highlight_search)&&(this.searchin>0)))||(screensaver_on&&flying&&this.targeted)) {context.beginPath();context.arc(n+a*(this.arcx),m+a*this.arcy,a*this.arcr,0,Math.PI*2,true);context.fillStyle=this.branchcolor();context.fill();if(!((this.npolyt)||(polytype==3))){context.beginPath();context.arc(n+a*(this.arcx),m+a*this.arcy,a*this.arcr*0.5,0,Math.PI*2,true);context.fillStyle=this.highlightcolor();context.fill()}}
	if(((this.npolyt)||((highlight_search)&&(this.searchin>0)))||(polytype==3)) {if(((a>thresholdnode))){if(intcircdraw){context.beginPath();context.arc(n+a*(this.arcx),m+a*this.arcy,a*this.arcr*(1-partl2/2),0,Math.PI*2,true);context.lineWidth=a*this.arcr*partl2;if(((highlight_search)&&(this.searchin>0))||(screensaver_on&&flying&&this.targeted)){context.strokeStyle=this.highlightcolor()}else{context.strokeStyle=this.barccolor()}context.stroke()}}else{if(intcircdraw){if((((highlight_search)&&(this.searchin>0))||(screensaver_on&&flying&&this.targeted))&&((a*this.arcr*partl2*2)>0.3)){var e=this.arca;var c=Math.sin(e);var l=Math.cos(e);var f=Math.sin(e+Math.PI/2);var q=Math.cos(e+Math.PI/2);context.beginPath();context.lineTo(n+a*(this.arcx)+0.4*a*this.arcr*l,m+a*this.arcy+0.4*a*this.arcr*c);context.lineTo(n+a*(this.arcx)-1*a*this.arcr*l+0.7*a*this.arcr*q,m+a*this.arcy-1*a*this.arcr*c+0.7*a*this.arcr*f);context.lineTo(n+a*(this.arcx)-1*a*this.arcr*l-0.7*a*this.arcr*q,m+a*this.arcy-1*a*this.arcr*c-0.7*a*this.arcr*f);context.lineTo(n+a*(this.arcx)+0.4*a*this.arcr*l,m+a*this.arcy+0.4*a*this.arcr*c);context.fillStyle=this.branchcolor();context.fill();context.fillStyle=this.highlightcolor();context.fill()}}}}
	if((this.npolyt)||(polytype==3)){
		var k=null;
		if((highlight_search)&&(this.searchin>0)) {if(this.searchin>1){k=(this.searchin).toString()+" hits"}else{k="1 hit"}}
		if(a>thresholdnode){
			if(a>thresholdtxt*270){
				if(this.num_pics>0){
					var o="";//null;
					//if((this.lengthbr)&&(this.lengthbr>0)) {context.fillStyle=this.datetextcolor();if(this.lengthbr>10){autotext_(false,(Math.round((this.lengthbr)*10)/10).toString()+" million years ago,",n+a*this.arcx,m+a*this.arcy-p*1.97,g*0.7,p/7)}else{if(this.lengthbr>1){autotext_(false,(Math.round((this.lengthbr)*100)/100).toString()+" million years ago,",n+a*this.arcx,m+a*this.arcy-p*1.97,g*0.7,p/7)}else{autotext_(false,(Math.round((this.lengthbr)*10000)/10).toString()+" thousand years ago,",n+a*this.arcx,m+a*this.arcy-p*1.97,g*0.7,p/7)}}autotext_(false,"during the "+gpmapper(this.lengthbr)+" period,",n+a*this.arcx,m+a*this.arcy-p*1.75,g,p/7);if((this.iprimaryname())||(this.isecondaryname())){o="lived the most recent common ancestor to today's"}else{o="lived the most recent common ancestor to"}}
					//else{context.fillStyle=this.datetextcolor();autotext_(false,"Date unknown",n+a*this.arcx,m+a*this.arcy-p*1.75,g,p/7);if((this.iprimaryname())||(this.isecondaryname())){o="The most recent common ancestor to today's"}else{o="The most recent common ancestor to"}}
					autotext_(false,o,n+a*this.arcx,m+a*this.arcy-p*1.53,g*1.2,p/7);
					var d=this.node_spec_txtline1();
					var h;
					if((highlight_search)&&(this.searchin>0)){if(this.searchin>1){d+=", "+(this.searchin).toString()+" are search hits"}else{d+=", 1 is a search hit"}}
					context.fillStyle=intnodetextcolor;
					if(this.cname) {this.autopic_set(n+a*this.arcx,m+a*this.arcy+g*0.07,g*1.43,g*0.77);if(this.cname.length>25){autotext2_(false,this.cname,n+a*this.arcx,m+a*this.arcy-p*1.15,g*1.37,p/4)}else{autotext_(false,this.cname,n+a*this.arcx,m+a*this.arcy-p*1.15,g*1.37,p/2.5)}if(this.name1){autotext_(false,"Scientific name: "+this.name1,n+a*this.arcx,m+a*this.arcy+p*1.5,g*1.25,p/5);autotext_(false,this.specnumfull(),n+a*this.arcx,m+a*this.arcy+p*1.8,g*1.25,p/5)}else{autotext_(false,this.specnumfull(),n+a*this.arcx,m+a*this.arcy+p*1.6,g*1.25,p/5)}}
					else {if(this.name1){this.autopic_set(n+a*this.arcx,m+a*this.arcy+g*0.07,g*1.43,g*0.77);autotext_(false,this.name1,n+a*this.arcx,m+a*this.arcy-p*1.15,g*1.37,p/2.5);autotext_(false,this.specnumfull(),n+a*this.arcx,m+a*this.arcy+p*1.6,g*1.25,p/5)}else{this.autopic_set(n+a*this.arcx,m+a*this.arcy-g*0.07,g*1.45,g*0.78);if((this.richness_val>=10000)){autotext2_(false,this.specnumfull(),n+a*this.arcx,m+a*this.arcy+p*1.45,g*1.37,p/2.5)}else{autotext_(false,this.specnumfull(),n+a*this.arcx,m+a*this.arcy+p*1.45,g*1.37,p/2.5)}}}
				}
				else{
					context.fillStyle=intnodetextcolor;
					var o="";//null;
					//if((this.lengthbr)&&(this.lengthbr>0)) {if(this.lengthbr>10){autotext_(false,(Math.round((this.lengthbr)*10)/10).toString()+" million years ago,",n+a*this.arcx,m+a*this.arcy-p*1.6,g,p/6)}else{if(this.lengthbr>1){autotext_(false,(Math.round((this.lengthbr)*100)/100).toString()+" million years ago,",n+a*this.arcx,m+a*this.arcy-p*1.6,g,p/6)}else{autotext_(false,(Math.round((this.lengthbr)*10000)/10).toString()+" thousand years ago,",n+a*this.arcx,m+a*this.arcy-p*1.6,g,p/6)}}autotext_(false,"during the "+gpmapper(this.lengthbr)+" period, lived",n+a*this.arcx,m+a*this.arcy-p*1.35,g*1.2,p/6);if((this.iprimaryname())||(this.isecondaryname())){o="the most recent common ancestor to today's"}else{o="the most recent common ancestor to"}}
					//else{autotext_(false,"Date unknown",n+a*this.arcx,m+a*this.arcy-p*1.35,g*1.2,p/6);if((this.iprimaryname())||(this.isecondaryname())){o="The most recent common ancestor to today's"}else{o="The most recent common ancestor to"}}
					autotext_(false,o,n+a*this.arcx,m+a*this.arcy-p*1.1,g*1.5,p/6);
					context.fillStyle=intnodetextcolor;
					if(this.cname) {if(this.name1){autotext3_(false,this.cname,n+a*this.arcx,m+a*this.arcy,g*1.5,p/2);autotext_(false,"Scientific name: "+this.name1,n+a*this.arcx,m+a*this.arcy+p*1.3,g*1.25,p/4);autotext_(false,this.specnumfull(),n+a*this.arcx,m+a*this.arcy+p*1.65,g*1.25,p/4)}else{autotext3_(false,this.cname,n+a*this.arcx,m+a*this.arcy,g*1.5,p/2);autotext_(false,this.specnumfull(),n+a*this.arcx,m+a*this.arcy+p*1.55,g*1.25,p/4)}}
					else {if(this.name1){autotext_(false,this.name1,n+a*this.arcx,m+a*this.arcy,g*1.5,p/2);autotext_(false,this.specnumfull(),n+a*this.arcx,m+a*this.arcy+p*1.55,g*1.25,p/4)}else{if((this.richness_val>=10000)){autotext2_(false,this.specnumfull(),n+a*this.arcx,m+a*this.arcy,g*1.25,p/2)}else{autotext_(false,this.specnumfull(),n+a*this.arcx,m+a*this.arcy,g*1.25,p/2)}}}
				}
			}
			else {context.fillStyle=intnodetextcolor;autotext_(false,"",//this.datepart(),
			n+a*this.arcx,m+a*this.arcy-p*1.55,g,p*0.6);if(this.cname){if(this.cname.match(/^\d/)&&(this.cname.length<4)){autotext3_(false,this.cname,n+a*this.arcx,m+a*this.arcy,1.65*a*this.arcr*(1-partl2/2),p*1.4)}else{autotext3_(false,this.cname,n+a*this.arcx,m+a*this.arcy,1.65*a*this.arcr*(1-partl2/2),p*0.57)}}else{if(this.name1){autotext2_(false,this.name1,n+a*this.arcx,m+a*this.arcy,1.65*a*this.arcr*(1-partl2/2),p*0.57)}else{if((this.richness_val>=10000)){autotext2_(true,this.specnumfull(),n+a*this.arcx,m+a*this.arcy,1.65*a*this.arcr*(1-partl2/2),p*0.57)}else{autotext_(true,this.specnumfull(),n+a*this.arcx,m+a*this.arcy,1.65*a*this.arcr*(1-partl2/2),p*0.57)}}}if((k)&&(this.num_sounds>0)){autotext2_(false,k,n+a*this.arcx+p*0.6,m+a*this.arcy+p*1.45,g,p*0.4);drawspeaker(n+a*(this.arcx)-p*0.6,m+a*this.arcy+p*1.45,a*this.arcr*0.2,((this.playing_sound)&&(thisSound.duration&&(thisSound.currentTime<thisSound.duration))),context,intnodetextcolor)}else{if(this.num_sounds>0){drawspeaker(n+a*(this.arcx),m+a*this.arcy+p*1.45,a*this.arcr*0.2,((this.playing_sound)&&(thisSound.duration&&(thisSound.currentTime<thisSound.duration))),context,intnodetextcolor)}if(k){autotext_(false,k,n+a*this.arcx,m+a*this.arcy+p*1.45,g*2,p*0.6)}}}
		}
	}
};

//drawPieSlice=function(a,h,e,g,f,b,d){if(f>0){var c=g+(f/d)*Math.PI*2;context.fillStyle=b;context.beginPath();context.moveTo(a,h);context.arc(a,h,e,g,c,false);context.fill()}};

//drawPie=function(a,g,e,c,d,b){var f=-c[c.length-1]/b;drawPieSlice(a,g,e*(1-pieborder/2),f,c[0]+c[1]+c[c.length-1],d[0],b);f=(c[0]/b)*Math.PI*2;for(i=1;i<c.length-1;i++){drawPieSlice(a,g,e*(1-pieborder/2),f,c[i]+c[i+1]/2,d[i],b);f=f+(c[i]/b)*Math.PI*2}drawPieSlice(a,g,e*(1-pieborder/2),f,c[c.length-1],d[c.length-1],b);context.strokeStyle=pie_background_color;context.lineWidth=e*pieborder;context.beginPath();context.arc(a,g,e*(1-pieborder/2),0,Math.PI*2,true);context.stroke()};

//drawPieKey=function(h,g,a,k,d,c,b,m,l,f,e,n){for(i=0;i<c.length;i++){context.fillStyle=pie_background_color;context.beginPath();context.arc(h-k/2+(i+0.5)*(k/c.length),g,a,0,Math.PI*2,true);context.fill();context.fillStyle=c[i];context.beginPath();context.arc(h-k/2+(i+0.5)*(k/c.length),g,a*(1-pieborder),0,Math.PI*2,true);context.fill();context.fillStyle=e;autotext_(false,f[i],h-k/2+(i+0.5)*(k/c.length),g,a*(1-pieborder)*1.5,a*(1-pieborder)*0.8);if(m[i]){autotext_(false,m[i],h-k/2+(i+0.5)*(k/c.length),g+a*(1-pieborder)*0.46,a*(1-pieborder)*1.5,a*(1-pieborder)*0.15)}if(l[i]){autotext_(true,l[i],h-k/2+(i+0.5)*(k/c.length),g+a*(1-pieborder)*0.7,a*(1-pieborder)*0.95,a*(1-pieborder)*0.15)}autotext_(false,(Math.round(10000*(d[i]/b))/100).toString()+" %",h-k/2+(i+0.5)*(k/c.length),g-a*(1-pieborder)*0.7,a*(1-pieborder)*0.95,a*(1-pieborder)*0.15);autotext_(false,(d[i]).toString()+" "+n,h-k/2+(i+0.5)*(k/c.length),g-a*(1-pieborder)*0.46,a*(1-pieborder)*1.5,a*(1-pieborder)*0.15)}};

autodraw_s=function(d,a,f,b,c){var e=true;load_image_s(d);if((!pic_loading_s[pic_vect_s[d]])&&(pic_cache_s[pic_vect_s[d]])){context.save();draw_src(a,f,b,c,b*0.03,context);context.clip();context.drawImage(pic_cache_s[pic_vect_s[d]],a,f,b,c);context.restore()}else{e=false}return e};

autodraw_l=function(d,a,f,b,c){var e=true;load_image_l(d);if((!pic_loading_l[pic_vect_l[d]])&&(pic_cache_l[pic_vect_l[d]])){context.save();draw_src(a,f,b,c,b*0.03,context);context.clip();context.drawImage(pic_cache_l[pic_vect_l[d]],a,f,b,c);context.restore()}else{load_image_s(d);if((!pic_loading_s[pic_vect_s[d]])&&(pic_cache_s[pic_vect_s[d]])){context.save();draw_src(a,f,b,c,b*0.03,context);context.clip();context.drawImage(pic_cache_s[pic_vect_s[d]],a,f,b,c);context.restore()}else{e=false}}return e};

autodraw_ls=function(d,a,k,b,c){var g=true;if(!((((a+b)<0)||((a)>widthres))||(((k+c)<0)||(k>heightres)))){if((b>800)||(c>800)){g=autodraw_l(d,a,k,b,c)}else{g=autodraw_s(d,a,k,b,c)}if((b>200)||(c>200)){var e=0.04;if(c>b){e=e*c}else{e=e*b}var f=null;if((mc_key_l[data_pic_col_credit])&&(metadata.leaf_meta[d][mc_key_l[data_pic_col_credit]])){f=metadata.leaf_meta[d][mc_key_l[data_pic_col_credit]]}if(copyright(context,a+b-e,k+c-e,e*(0.8),f,global_auto_button,"rgb(90,90,90)","rgb(190,190,190)","rgb(255,255,255)")){global_button_action="http://eol.org/data_objects/"+(metadata.leaf_meta[d][mc_key_l.picID]).toString();is_clicked=true}}}return g};

var global_auto_button;

autobuttonxy=function(){var a=null;var b=null;if(clicking||(!mousehold)){a=mouseX;b=mouseY}if((!pinchhold)&&(touchhold||touch_button)){a=last_x_touch;b=last_y_touch}if(a&&b){return[a,b]}else{return null}};

autodraw_lsc=function(e,d,b,c,f){load_image_s(e);if((!pic_loading_s[pic_vect_s[e]])&&(pic_cache_s[pic_vect_s[e]])){var a=false;if(global_auto_button&&((((global_auto_button[0]-d)*(global_auto_button[0]-d))+((global_auto_button[1]-b)*(global_auto_button[1]-b)))<=(c*c))){a=true;tap2zoom=f}context.save();context.beginPath();context.arc(d,b,c*0.97,0,Math.PI*2,true);context.clip();context.drawImage(pic_cache_s[pic_vect_s[e]],d-c*0.97,b-c*0.97,c*2*0.97,c*2*0.97);context.restore();context.beginPath();context.lineWidth=c*0.03;if(a){context.arc(d,b,c*1.02,0,Math.PI*2,true);context.strokeStyle="rgba(0,0,0,0.5)"}else{context.arc(d,b,c,0,Math.PI*2,true);context.strokeStyle="rgba(255,255,255,0.5)"}context.stroke();context.beginPath();context.arc(d,b,c*0.97,0,Math.PI*2,true);if(a){context.lineWidth=c*0.03;context.strokeStyle="rgb(255,255,255)"}else{context.lineWidth=c*0.03;context.strokeStyle="rgb(255,255,255)"}context.stroke()}else{pics_unloaded=true}};

midnode.prototype.autopic=function(f,g,l,a,c,d){var k=false;load_image_s(this.picset_code[f]);if((!pic_loading_s[pic_vect_s[this.picset_code[f]]])&&(pic_cache_s[pic_vect_s[this.picset_code[f]]])){k=true}else{k=false}if(k){var h=(pic_cache_s[pic_vect_s[this.picset_code[f]]].width);var b=(pic_cache_s[pic_vect_s[this.picset_code[f]]].height);if((h/b)>(a/c)){b=a*b/h;h=a}else{h=c*h/b;b=c}autodraw_ls(this.picset_code[f],g-h/2,l-b/2,h,b);context.fillStyle=intnodetextcolor;var e=null;if(metadata.leaf_meta[this.picset_code[f]][mc_key_l.common_en]){e=metadata.leaf_meta[this.picset_code[f]][mc_key_l.common_en]}else{e=this.picset_latin[f]}if(e&&d){autotext_(false,e,g,l+b/2+c*(0.085),h,c*(0.1))}}else{pics_unloaded=true}};

midnode.prototype.autopic_set=function(e,a,c,g){if(!((((e+c/2)<0)||((e-c/2)>widthres))||(((a+g/2)<0)||((a-g/2)>heightres)))){if((this.picset_code).length<4){var d=c/((this.picset_code).length);for(i=0;i<(this.picset_code).length;i++){if((this.picset_code).length>1){this.autopic(i,e-c/2+d*(i+0.5),a,d*0.88,g,true)}else{this.autopic(i,e-c/2+d*(i+0.5),a,d*0.88,g,false)}}}else{var f=Math.floor(((this.picset_code).length)/2);var b=(this.picset_code).length-f;var d=c/4;for(ij=0;ij<f;ij++){this.autopic(ij,e-f*d/2+d*(ij+0.5),a-g/4,d*0.85,g/2*0.85,true)}d=c/4;for(j=0;j<(b);j++){this.autopic(f+j,e-b*d/2+d*(j+0.5),a+g/4,d*0.85,g/2*0.85,true)}}}};

midnode.prototype.drawSpeakerSet=function(g,f,l,a){var m=g-l*0.8;var o=f-l*0.35;var n=g-l*0.1;var q=f+l*0.35;var d=g-l*1.7;var w=f-l*0.35;var c=g-l*1;var v=f+l*0.35;context.fillStyle="rgb(255,255,255)";context.strokeStyle="rgb(255,255,255)";drawspeaker(g+l,f,l,a,context,"rgb(255,255,255)");if(l>30){if(this.num_sounds>1){autotext2_(false,this.num_sounds.toString()+" descendent animal sounds",g-l*0.3,f-l*0.77,l*1.5,l*0.35)}else{autotext2_(false,"1 descendent animal sound",g-l*0.3,f-l*0.77,l*1.5,l*0.35)}if(a&&nowplaying){var u;if(commonlabels&&metadata.leaf_meta[nowplaying][mc_key_l.common_en]){u="Now playing: "+metadata.leaf_meta[nowplaying][mc_key_l.common_en]}else{u="Now playing: "+meta2latin(nowplaying)}autotext2_(false,u,g-l*0.3,f+l*0.77,l*1.5,l*0.35)}else{autotext_(false,"Touch to start",g-l*0.3,f+l*0.77,l*1.5,l*0.35)}}if(a){if((mc_key_l[data_pic_col])&&(metadata.leaf_meta[nowplaying][mc_key_l[data_pic_col]])){var k;var s;var p=false;load_image_s(nowplaying);if((!pic_loading_s[pic_vect_s[nowplaying]])&&(pic_cache_s[pic_vect_s[nowplaying]])){p=true}else{p=false}if(p){if((pic_cache_s[pic_vect_s[nowplaying]].width)>((pic_cache_s[pic_vect_s[nowplaying]].height)/0.7*0.8)){k=l*0.8;s=k/(pic_cache_s[pic_vect_s[nowplaying]].width)*(pic_cache_s[pic_vect_s[nowplaying]].height)}else{s=l*0.7;k=s/(pic_cache_s[pic_vect_s[nowplaying]].height)*(pic_cache_s[pic_vect_s[nowplaying]].width)}if(Math.max(k,s)>50){autodraw_ls(nowplaying,g+l*0.55-k/2,f-s/2,k,s)}else{context.fillStyle="rgba(0,0,0,0.2)";context.fillRect(g+l*0.55-k/2,f-s/2,k,s)}}else{pics_unloaded=true}}}var h=false;var b=false;if(l>30){if(((screensaver_on)&&(!flying))&&(g>widthres*0.3)&&(g<widthres*0.7)){if(!((thisSound.duration)&&(thisSound.currentTime<thisSound.duration))){play_sound(this.randomsound())}}if(((((last_x_touch>m)&&(last_x_touch<n))&&((last_y_touch>o)&&(last_y_touch<q)))&&(!pinchhold)&&(touchhold||touch_button))||((((mouseX>m)&&(mouseX<n))&&((mouseY>o)&&(mouseY<q)))&&(!mousehold)&&(!mouse_disable))){if((this.num_sounds>1)||(!a)){h=true;if((((last_x_touch>m)&&(last_x_touch<n))&&((last_y_touch>o)&&(last_y_touch<q)))&&(!pinchhold)&&(touchhold||touch_button)){touch_button=true}if(!soundqueue){soundqueue=this.randomsound();if(((thisSound.currentTime)&&(thisSound.currentTime<thisSound.duration))||(justplayednew&&nowplaying)){while(soundqueue==nowplaying){soundqueue=this.randomsound()}}}}}if(((((last_x_touch>d)&&(last_x_touch<c))&&((last_y_touch>w)&&(last_y_touch<v)))&&(!pinchhold)&&(touchhold||touch_button))||((((mouseX>d)&&(mouseX<c))&&((mouseY>w)&&(mouseY<v)))&&(!mousehold)&&(!mouse_disable))){if(a){if((((last_x_touch>d)&&(last_x_touch<c))&&((last_y_touch>w)&&(last_y_touch<v)))&&(!pinchhold)&&(touchhold||touch_button)){touch_button=true}b=true;queuestop=true}}}if(a){var e;context.lineWidth=l*0.05;context.beginPath();context.moveTo(g-l*1.7,f+l*0.35);context.lineTo(g-l*1,f+l*0.35);context.lineTo(g-l*1,f-l*0.35);context.lineTo(g-l*1.7,f-l*0.35);context.lineTo(g-l*1.7,f+l*0.35);if(b){context.fillStyle="rgb(255,255,255)";context.fill();context.strokeStyle="rgb(0,0,0)";context.stroke();e="rgb(255,255,255)";context.fillStyle="rgb(0,0,0)"}else{context.strokeStyle="rgb(255,255,255)";context.stroke();e=this.branchcolor();context.fillStyle="rgb(255,255,255)"}if(b){e="rgb(255,255,255)";context.fillStyle="rgb(0,0,0)"}else{e=this.branchcolor();context.fillStyle="rgb(255,255,255)"}context.beginPath();context.moveTo(g-l*1.55,f+l*0.2);context.lineTo(g-l*1.15,f+l*0.2);context.lineTo(g-l*1.15,f-l*0.2);context.lineTo(g-l*1.55,f-l*0.2);context.lineTo(g-l*1.55,f+l*0.2);context.fill();context.fillStyle=e;autotext_(false,"Stop sound",g-l*1.35,f,l*0.3,l*0.05)}if((this.num_sounds>1)||(!a)){context.lineWidth=l*0.05;context.beginPath();context.moveTo(g-l*0.8,f+l*0.35);context.lineTo(g-l*0.1,f+l*0.35);context.lineTo(g-l*0.1,f-l*0.35);context.lineTo(g-l*0.8,f-l*0.35);context.lineTo(g-l*0.8,f+l*0.35);var z;if(h){context.fillStyle="rgb(255,255,255)";context.fill();context.strokeStyle="rgb(0,0,0)";context.stroke();z="rgb(255,255,255)";context.fillStyle="rgb(0,0,0)"}else{context.strokeStyle="rgb(255,255,255)";context.stroke();z=this.branchcolor();context.fillStyle="rgb(255,255,255)"}if(a){if(h){z="rgb(255,255,255)";context.fillStyle="rgb(0,0,0)"}else{z=this.branchcolor();context.fillStyle="rgb(255,255,255)"}context.lineWidth=l*0.05;context.beginPath();context.moveTo(g-l*0.45,f+l*0.2);context.lineTo(g-l*0.2,f);context.lineTo(g-l*0.45,f-l*0.2);context.lineTo(g-l*0.45,f-l*0.2);context.fill();context.beginPath();context.moveTo(g-l*0.65,f+l*0.2);context.lineTo(g-l*0.4,f);context.lineTo(g-l*0.65,f-l*0.2);context.lineTo(g-l*0.65,f-l*0.2);context.fill();context.beginPath();context.moveTo(g-l*0.22,f+l*0.2);context.lineTo(g-l*0.22,f-l*0.2);context.stroke();context.fillStyle=z;autotext_(false,"New random sound",g-l*0.45,f,l*0.3,l*0.05)}else{context.beginPath();context.moveTo(g-l*0.65,f+l*0.3);context.lineTo(g-l*0.25,f);context.lineTo(g-l*0.65,f-l*0.3);context.lineTo(g-l*0.65,f-l*0.3);context.fill();context.fillStyle=z;autotext_(false,"Play random sound",g-l*0.47,f,l*0.3,l*0.05)}}};

midnode.prototype.drawspeaker_leaf=function(k,g,a,l){var e=k-a*1; var c=g-a*0.4;var m=k-a*0.2;var f=g+a*0.4;context.fillStyle="rgb(255,255,255)";context.strokeStyle="rgb(255,255,255)";drawspeaker(k+a,g,a,l,context,"rgb(255,255,255)");if(a>30){autotext2_(false,"Animal sound player",k-a*0.3,g-a*0.77,a*1.5,a*0.35);if(l){var b;b="Touch to stop sound";autotext_(false,b,k-a*0.3,g+a*0.77,a*1.5,a*0.35)}else{autotext_(false,"Touch to play sound",k-a*0.3,g+a*0.77,a*1.5,a*0.35)}}var d=false;if(a>30){if(((((last_x_touch>e)&&(last_x_touch<m))&&((last_y_touch>c)&&(last_y_touch<f)))&&(!pinchhold)&&(touchhold||touch_button))||((((mouseX>e)&&(mouseX<m))&&((mouseY>c)&&(mouseY<f)))&&(!mousehold)&&(!mouse_disable))){d=true;if((((last_x_touch>e)&&(last_x_touch<m))&&((last_y_touch>c)&&(last_y_touch<f)))&&(!pinchhold)&&(touchhold||touch_button)){touch_button=true}if((nowplaying==this.metacode)&&(((thisSound.duration)&&(thisSound.currentTime<thisSound.duration)))){queuestop=true}else{soundqueue=this.metacode}}}context.lineWidth=a*0.05;context.beginPath();context.moveTo(k-a*1,g+a*0.4);context.lineTo(k-a*0.2,g+a*0.4);context.lineTo(k-a*0.2,g-a*0.4);context.lineTo(k-a*1,g-a*0.4);context.lineTo(k-a*1,g+a*0.4);var h;if(d){context.fillStyle="rgb(255,255,255)";context.fill();context.strokeStyle="rgb(0,0,0)";context.stroke();h="rgb(255,255,255)";context.fillStyle="rgb(0,0,0)"}else{context.strokeStyle="rgb(255,255,255)";context.stroke();h=this.leafcolor1();context.fillStyle="rgb(255,255,255)"}if(l){context.beginPath();context.moveTo(k-a*0.8,g+a*0.2);context.lineTo(k-a*0.4,g+a*0.2);context.lineTo(k-a*0.4,g-a*0.2);context.lineTo(k-a*0.8,g-a*0.2);context.lineTo(k-a*0.8,g+a*0.2)}else{context.beginPath();context.moveTo(k-a*0.8,g+a*0.3);context.lineTo(k-a*0.4,g);context.lineTo(k-a*0.8,g-a*0.3);context.lineTo(k-a*0.8,g-a*0.3)}context.fill();context.fillStyle=h;if(l){autotext_(false,"Stop sound",k-a*0.62,g,a*0.3,a*0.05)}else{autotext_(false,"Play sound",k-a*0.62,g,a*0.3,a*0.05)}};

function onscreen(a,b){if(a<0){return false}if(a>widthres){return false}if(b<0){return false}if(b>heightres){return false}return true}
midnode.prototype.in_centre=function(a){return(this.dvar)};

midnode.prototype.mylocation=function(a){if(this.dvar){if(this.child1){if(uplocation){lastuplocation=uplocation}uplocation=this.metacode}else{if(uplocation){lastuplocation=uplocation}uplocation=(-this.metacode)}if(commonlabels){if(this.cname){if((this.cname.search("and more")==-1)&&((this.cname.search(",")==-1))){locationtxt+=(this.cname);locationvect[locationvect.length]=(this.cname);if(this.child1){locationtxt+=" > ";locationvect_index[locationvect_index.length]=this.metacode}else{locationvect_index[locationvect_index.length]=(-this.metacode)}}}else{if(!this.child1){locationtxt+=(this.name2+" "+this.name1);locationvect[locationvect.length]=(this.name2+" "+this.name1);locationvect_index[locationvect_index.length]=(-this.metacode)}}}else{if(this.child1){if(this.name1){locationtxt+=(this.name1+" > ");locationvect[locationvect.length]=this.name1;locationvect_index[locationvect_index.length]=(this.metacode)}}else{locationtxt+=(this.name2+" "+this.name1);locationvect[locationvect.length]=(this.name2+" "+this.name1);locationvect_index[locationvect_index.length]=(-this.metacode)}}if(this.child1){if(this.child1.dvar){if(!((this.child2).in_centre(a))){this.child1.mylocation(a)}}else{if(this.child2.dvar){if(!((this.child1).in_centre(a))){this.child2.mylocation(a)}}}}}};

midnode.prototype.mylocation2=function(){if(this.dvar){if(this.gvar){if(this.child1){return(this.metacode)}else{return([])}}else{if(this.child1){var b=this.child1.mylocation2();var a=this.child2.mylocation2();if(b.length==0){if(a.length==0){return(this.metacode)}else{return(([this.metacode]).concat(a))}}else{if(a.length==0){return(([this.metacode]).concat(b))}else{return(this.metacode)}}}else{return([])}}}else{return([])}};

midnode.prototype.viewRichness=function(){var b=0;var a;var e;var d;if(this.dvar){if(this.rvar){a=this.xvar;e=this.yvar;d=this.rvar}if(this.child1){b=b+this.child1.viewRichness();b=b+this.child2.viewRichness()}var c=false;if((this.gvar)&&((polytype!=2)||(this.npolyt))){c=true}if((this.lengthbr>timelim)&&(c)){if((((this.richness_val>1)&&(this.child1))&&(d<=threshold))&&(timelim<=0)){b=b+this.richness_val}else{if(c){if(!((this.richness_val>1)&&(this.child1))){b=b+this.richness_val}}}}}return(b)};

midnode.prototype.mylocation3=function(){if(this.dvar){if(this.gvar){if(this.child1){if(this.cname){return([[this.cname],[this.metacode],true,[this.richness_val]])}else{return([[],[],true,[]])}}else{return([[],[],false,[]])}}else{if(this.child1){var b=this.child1.mylocation3();var a=this.child2.mylocation3();if(b[2]==false){if(a[2]==false){if(this.cname){return([[this.cname],[this.metacode],true,[this.richness_val]])}else{return([[],[],true,[]])}}else{if(this.cname){return([([this.cname]).concat(a[0]),([this.metacode]).concat(a[1]),true,[this.richness_val].concat(a[3])])}else{return([a[0],a[1],true,a[3]])}}}else{if(a[2]==false){if(this.cname){return([([this.cname]).concat(b[0]),([this.metacode]).concat(b[1]),true,[this.richness_val].concat(b[3])])}else{return([b[0],b[1],true,b[3]])}}else{if(this.cname){return([[this.cname],[this.metacode],true,[this.richness_val]])}else{return([[],[],true,[]])}}}}else{return([[],[],false,[]])}}}else{return([[],[],false,[]])}};

function getMyLocation(){return(fulltree.mylocation3())}
function performsearch2(b){var a=searchstring;last_searched=searchstring;if(screensaver_on){performsearch2b(b,"picturebest")}else{performsearch2b(b,a)}}
function performsearch2b(e,c){searchinteriornodes=false;var b=false;var a=c;var d=a.split(" ");if(d.length==searchinparts.length){for(i=0;i<d.length;i++){if(d[i]!=searchinparts[i]){b=true}}}else{b=true}traitsearch=true;if(!b){if(e){fulltree.semiclearsearch()}b=false}else{fulltree.clearsearch();searchinparts=d;numhits=fulltree.search();b=true}return b}
var traitsearch;

midnode.prototype.searchone=function(c,b){var a=0;if(a==0&&latin_search){if((c.toLowerCase())==c){if(!((b)&&(this.child1))){if((this.name1)&&((this.name1.toLowerCase()).search(c)!=-1)){a+=this.richness_val}else{if(((this.name2)&&((this.name2.toLowerCase()).search(c)!=-1))&&(!this.child1)){a+=this.richness_val}}}}else{if(!((b)&&(this.child1))){if((this.name1)&&((this.name1).search(c)!=-1)){a+=this.richness_val}else{if(((this.name2)&&((this.name2).search(c)!=-1))&&(!this.child1)){a+=this.richness_val}}}}}if(a==0&&common_search){if(!((b)&&(this.child1))){if((c.toLowerCase())==c){if((this.cname)&&((this.cname.toLowerCase()).search(c)!=-1)){a+=this.richness_val}}else{if((this.cname)&&((this.cname).search(c)!=-1)){a+=this.richness_val}}}}if(!(this.child1)){if(search_sounds){if(!(((mc_key_l.sound)&&(metadata.leaf_meta[this.metacode][mc_key_l.sound]))&&(metadata.leaf_meta[this.metacode][mc_key_l.sound]=="1"))){a=0}}if(search_images){if(!((this.num_pics>0))){a=0}}}else{if(search_sounds){a=0}if(search_images){a=0}}return(a>0)};

midnode.prototype.searchword=function(b){var a=null;if(common_search&&this.cname){var c=(this.cname.toLowerCase()).split(" ");for(i=0;i<c.length;i++){if(b==c[i]){a=true}}}if(latin_search){if((this.name1)&&(b==(this.name1.toLowerCase()))){a=true}if((this.name2)&&(b==(this.name2.toLowerCase()))){a=true}}if(!(this.child1)){if(search_sounds){if(!(((mc_key_l.sound)&&(metadata.leaf_meta[this.metacode][mc_key_l.sound]))&&(metadata.leaf_meta[this.metacode][mc_key_l.sound]=="1"))){a=null}}if(search_images){if(!((this.num_pics>0))){a=null}}}else{if(search_sounds){a=null}if(search_images){a=null}}return a};

midnode.prototype.searchfull=function(b){var a=null;if(common_search&&this.cname){var c=(this.cname.toLowerCase()).split(" ");if(b.length==c.length){a=true;for(i=0;i<c.length;i++){if(b[i]!=c[i]){a=null}}}}if((latin_search)&&(!a)){if((b.length==2)&&(!this.child1)){if(this.name1||this.name2){a=true}if((this.name1)&&(b[0]!=(this.name1.toLowerCase()))){a=null}if((this.name2)&&(b[1]!=(this.name2.toLowerCase()))){a=null}}if(((this.child1)&&(b.length==1))&&this.name1){a=true;if((b[0]!=(this.name1.toLowerCase()))){a=null}}}if(!(this.child1)){if(search_sounds){if(!(((mc_key_l.sound)&&(metadata.leaf_meta[this.metacode][mc_key_l.sound]))&&(metadata.leaf_meta[this.metacode][mc_key_l.sound]=="1"))){a=null}}if(search_images){if(!((this.num_pics>0))){a=null}}}else{if(search_sounds){a=null}if(search_images){a=null}}return a};

midnode.prototype.numgp_counter=function(){if(this.child1){this.child1.numgp_counter();this.child2.numgp_counter();this.num_good_pics=((this.child1).num_good_pics+(this.child2).num_good_pics)}else{if(this.pic_qual>=30000){this.num_good_pics=1}else{this.num_good_pics=0}}};

midnode.prototype.picsort=function(){if(this.child1){if(this.num_pics>0){this.child1.picsort();this.child2.picsort();var b=0;if(this.child1.picset_file){b=this.child1.picset_file.length}var a=0;if(this.child2.picset_file){a=this.child2.picset_file.length}if(b==0){this.picset_file=this.child2.picset_file;this.picset_qual=this.child2.picset_qual;this.picset_common=this.child2.picset_common;this.picset_latin=this.child2.picset_latin;this.picset_code=this.child2.picset_code;this.MRCA_pic=false}else{if(a==0){this.picset_file=this.child1.picset_file;this.picset_qual=this.child1.picset_qual;this.picset_common=this.child1.picset_common;this.picset_latin=this.child1.picset_latin;this.picset_code=this.child1.picset_code;this.MRCA_pic=false}else{this.MRCA_pic=true;if((a+b)>num_int_pics){if(this.child1.richness_val>this.child2.richness_val){a=Math.floor(((num_int_pics*this.child2.richness_val)/(this.richness_val))+0.5);if(a<1){a=1}b=num_int_pics-a}else{b=Math.floor(((num_int_pics*this.child1.richness_val)/(this.richness_val))+0.5);if(b<1){b=1}a=num_int_pics-b}if(a>this.child2.picset_file.length){a=this.child2.picset_file.length;b=num_int_pics-a}if(b>this.child1.picset_file.length){b=this.child1.picset_file.length;a=num_int_pics-b}}this.picset_file=new Array();this.picset_qual=new Array();this.picset_common=new Array();this.picset_latin=new Array();this.picset_code=new Array();if((qualcomp(this.child1.picset_qual[0]))>(qualcomp(this.child2.picset_qual[0]))){this.picset_file[0]=this.child1.picset_file[0];this.picset_file[1]=this.child2.picset_file[0];this.picset_code[0]=this.child1.picset_code[0];this.picset_code[1]=this.child2.picset_code[0];this.picset_qual[0]=this.child1.picset_qual[0];this.picset_qual[1]=this.child2.picset_qual[0];this.picset_common[0]=this.child1.picset_common[0];this.picset_common[1]=this.child2.picset_common[0];this.picset_latin[0]=this.child1.picset_latin[0];this.picset_latin[1]=this.child2.picset_latin[0]}else{if((qualcomp(this.child2.picset_qual[0]))>(qualcomp(this.child1.picset_qual[0]))){this.picset_file[0]=this.child2.picset_file[0];this.picset_file[1]=this.child1.picset_file[0];this.picset_code[0]=this.child2.picset_code[0];this.picset_code[1]=this.child1.picset_code[0];this.picset_qual[0]=this.child2.picset_qual[0];this.picset_qual[1]=this.child1.picset_qual[0];this.picset_common[0]=this.child2.picset_common[0];this.picset_common[1]=this.child1.picset_common[0];this.picset_latin[0]=this.child2.picset_latin[0];this.picset_latin[1]=this.child1.picset_latin[0]}else{if(this.child1.richness_val>=this.child2.richness_val){this.picset_file[0]=this.child1.picset_file[0];this.picset_file[1]=this.child2.picset_file[0];this.picset_code[0]=this.child1.picset_code[0];this.picset_code[1]=this.child2.picset_code[0];this.picset_qual[0]=this.child1.picset_qual[0];this.picset_qual[1]=this.child2.picset_qual[0];this.picset_common[0]=this.child1.picset_common[0];this.picset_common[1]=this.child2.picset_common[0];this.picset_latin[0]=this.child1.picset_latin[0];this.picset_latin[1]=this.child2.picset_latin[0]}else{this.picset_file[0]=this.child2.picset_file[0];this.picset_file[1]=this.child1.picset_file[0];this.picset_code[0]=this.child2.picset_code[0];this.picset_code[1]=this.child1.picset_code[0];this.picset_qual[0]=this.child2.picset_qual[0];this.picset_qual[1]=this.child1.picset_qual[0];this.picset_common[0]=this.child2.picset_common[0];this.picset_common[1]=this.child1.picset_common[0];this.picset_latin[0]=this.child2.picset_latin[0];this.picset_latin[1]=this.child1.picset_latin[0]}}}if(b>a){if(1<a){for(i=1;i<a;i++){this.picset_file[2*i]=this.child1.picset_file[i];this.picset_code[2*i]=this.child1.picset_code[i];this.picset_qual[2*i]=this.child1.picset_qual[i];this.picset_common[2*i]=this.child1.picset_common[i];this.picset_latin[2*i]=this.child1.picset_latin[i];this.picset_file[2*i+1]=this.child2.picset_file[i];this.picset_code[2*i+1]=this.child2.picset_code[i];this.picset_qual[2*i+1]=this.child2.picset_qual[i];this.picset_common[2*i+1]=this.child2.picset_common[i];this.picset_latin[2*i+1]=this.child2.picset_latin[i]}}for(i=(a);i<b;i++){this.picset_file[i+1+(a-1)]=this.child1.picset_file[i];this.picset_code[i+1+(a-1)]=this.child1.picset_code[i];this.picset_qual[i+1+(a-1)]=this.child1.picset_qual[i];this.picset_common[i+1+(a-1)]=this.child1.picset_common[i];this.picset_latin[i+1+(a-1)]=this.child1.picset_latin[i]}}else{if(1<b){for(i=1;i<b;i++){this.picset_file[2*i]=this.child2.picset_file[i];this.picset_code[2*i]=this.child2.picset_code[i];this.picset_qual[2*i]=this.child2.picset_qual[i];this.picset_common[2*i]=this.child2.picset_common[i];this.picset_latin[2*i]=this.child2.picset_latin[i];this.picset_file[2*i+1]=this.child1.picset_file[i];this.picset_code[2*i+1]=this.child1.picset_code[i];this.picset_qual[2*i+1]=this.child1.picset_qual[i];this.picset_common[2*i+1]=this.child1.picset_common[i];this.picset_latin[2*i+1]=this.child1.picset_latin[i]}}if(b<a){for(i=(b);i<a;i++){this.picset_file[i+1+(b-1)]=this.child2.picset_file[i];this.picset_code[i+1+(b-1)]=this.child2.picset_code[i];this.picset_qual[i+1+(b-1)]=this.child2.picset_qual[i];this.picset_common[i+1+(b-1)]=this.child2.picset_common[i];this.picset_latin[i+1+(b-1)]=this.child2.picset_latin[i]}}}var d=false;while(!d){d=true;for(i=0;i<this.picset_file.length;i++){for(j=i+1;j<this.picset_file.length;j++){if(this.picset_file[i]==this.picset_file[j]){this.picset_file[j]=this.picset_file[this.picset_file.length-1];this.picset_file.length--;this.picset_code[j]=this.picset_code[this.picset_code.length-1];this.picset_code.length--;this.picset_qual[j]=this.picset_qual[this.picset_qual.length-1];this.picset_qual.length--;this.picset_common[j]=this.picset_common[this.picset_common.length-1];this.picset_common.length--;this.picset_latin[j]=this.picset_latin[this.picset_latin.length-1];this.picset_latin.length--;d=false}}}}d=false;while(!d){d=true;for(i=0;i<this.picset_qual.length-1;i++){if((qualcomp(this.picset_qual[i]))<(qualcomp(this.picset_qual[i+1]))){d=false;var c=this.picset_qual[i];this.picset_qual[i]=this.picset_qual[i+1];this.picset_qual[i+1]=c;c=this.picset_file[i];this.picset_file[i]=this.picset_file[i+1];this.picset_file[i+1]=c;c=this.picset_common[i];this.picset_common[i]=this.picset_common[i+1];this.picset_common[i+1]=c;c=this.picset_latin[i];this.picset_latin[i]=this.picset_latin[i+1];this.picset_latin[i+1]=c;c=this.picset_code[i];this.picset_code[i]=this.picset_code[i+1];this.picset_code[i+1]=c}}}}}}else{this.picset_file=null;this.picset_qual=null;this.picset_common=null;this.picset_latin=null}}else{if(this.pic_file){this.picset_code=new Array();this.picset_file=new Array();this.picset_qual=new Array();this.picset_common=new Array();this.picset_latin=new Array();this.picset_file[0]=this.pic_file;this.picset_qual[0]=this.pic_qual;this.picset_code[0]=this.metacode;if(this.cname){this.picset_common[0]=this.cname}else{this.picset_common[0]=null}if(this.name1){if(this.name2){this.picset_latin[0]=this.name2+" "+this.name1}else{this.picset_latin[0]=this.name1}}else{if(this.name2){this.picset_latin[0]=this.name2}else{this.picset_latin[0]=null}}}else{this.picset_file=null;this.picset_qual=null;this.picset_common=null;this.picset_latin=null;this.picset_code=null}}};

function qualcomp(a){return(a)};